<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Versioning &amp; Retrieving All Files From AWS S3 With Boto | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<!-- <link href="/assets/css/rst_base.css" rel="stylesheet" type="text/css"> --><link href="../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/style.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/carbon.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://avilpage.com/2019/07/aws-s3-bucket-objects-versions.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../05/total-recall-grandma-phone-numbers.html" title="Why My Grandma Can Recall 100+ Phone Numbers, But We Can't" type="text/html">
<link rel="next" href="../08/django-profile-optimize-views.html" title="Profiling &amp; Optimizing Bottlenecks In Django" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Versioning &amp; Retrieving All Files From AWS S3 With Boto">
<meta property="og:url" content="http://avilpage.com/2019/07/aws-s3-bucket-objects-versions.html">
<meta property="og:description" content="Introduction
Amazon S3 (Amazon Simple Storage Service) is an object storage service offered by Amazon Web Services. For S3 buckets, if versioning is enabled, users can preserve, retrieve, and restore ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-07-24T21:21:21+05:30">
<meta property="article:tag" content="aws">
<meta property="article:tag" content="python">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://avilpage.com/">

                <span id="blog-title">Avil Page</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../">Articles</a>
                </li>
<li>
<a href="../../p/talks.html">Talks</a>
                </li>
<li>
<a href="../../p/projects.html">Projects</a>
                </li>
<li>
<a href="../../p/about.html">About</a>
                </li>
<li>
<a href="../../rss.xml">RSS</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
            <a href="aws-s3-bucket-objects-versions.md" id="sourcelink">Source</a>
        </li>
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content col-lg-6 col-lg-offset-3 col-xs-12 col-md-12">
        <!--Body content-->
        <div class="row">
            
    <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Versioning &amp; Retrieving All Files From AWS S3 With Boto</a></h1>

        <div class="metadata">
            <p class="dateline">
                <time class="published dt-published" datetime="2019-07-24T21:21:21+05:30" itemprop="datePublished" title="24 Jul 19">24 Jul 2019</time></p>
            |
            

        6 min read


        </div>
        
    </header><hr>
<div class="e-content entry-content" itemprop="articleBody text">
            <div>
<h4>Introduction</h4>
<p><a href="https://aws.amazon.com/s3/">Amazon S3</a> (Amazon Simple Storage Service) is an object storage service offered by Amazon Web Services. For S3 buckets, if versioning is enabled, users can preserve, retrieve, and restore every version of the object stored in the bucket.</p>
<p>In this article, we will understand how to enable versioning for a bucket and retrieve all versions of an object from AWS web interface as well as <a href="https://pypi.org/project/boto3/">Python boto</a> library.</p>
<h4>Versioning of Bucket</h4>
<p>Bucket versioning can be changed with a toggle button from the AWS web console in the bucket properties.</p>
<p align="center">
<img src="../../images/aws-s3-bucket-version1.png"></p>

<p>We can do the same with Python boto3 library.</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">boto3</span>


<span class="n">bucket_name</span> <span class="o">=</span> <span class="s1">'avilpage'</span>

<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">'s3'</span><span class="p">)</span>
<span class="n">versioning</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">BucketVersioning</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

<span class="c1"># check status</span>
<span class="k">print</span><span class="p">(</span><span class="n">versioning</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<span class="c1"># enable versioning</span>
<span class="n">versioning</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="c1"># disable versioning</span>
<span class="n">versioning</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>
</pre>


<h4>Retrieving Objects</h4>
<p>Once versioning is enabled, we can store multiple versions of an object by uploading an object multiple times with the same key.</p>
<p>We can write a simple script to generate a text file with a random text and upload it to S3.</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">file_name</span> <span class="o">=</span> <span class="s1">'test.txt'</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">file_name</span>
<span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">'s3'</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">s3</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</pre>


<p>If this script is executed multiple times, the same file gets overridden with a different version id with the same key in the bucket.</p>
<p>We can see all the versions of the file from the bucket by selecting the file and then clicking drop-down at <code>Latest version</code>.</p>
<p align="center">
<img src="../../images/aws-s3-bucket-version2.png"></p>

<p>We can write a script to retrieve and show contents of all the versions of the test.txt file with the following script.</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">boto3</span>


<span class="n">bucket_name</span> <span class="o">=</span> <span class="s1">'avilpage'</span>
<span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">'s3'</span><span class="p">)</span>

<span class="n">versions</span> <span class="o">=</span> <span class="n">s3_client</span><span class="o">.</span><span class="n">list_object_versions</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">)</span>

<span class="k">for</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">versions</span><span class="p">:</span>
    <span class="n">version_id</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="s1">'Versions'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'VersionId'</span><span class="p">]</span>
    <span class="n">file_key</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="s1">'Versions'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'Key'</span><span class="p">]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span>
        <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span>
        <span class="n">Key</span><span class="o">=</span><span class="n">file_key</span><span class="p">,</span>
        <span class="n">VersionId</span><span class="o">=</span><span class="n">version_id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">'Body'</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre>


<h4>Conclusion</h4>
<p>Object versioning is useful to protect data from unintended overwrites. In this article, we learnt how to change bucket versioning, upload multiple versions of same file and retrieving all versions of the file using AWS web console as well as boto3.</p>
</div>
        </div>
        <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/aws.html" rel="tag">aws</a></li>
            <li><a class="tag p-category" href="../../tags/python.html" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../05/total-recall-grandma-phone-numbers.html" rel="prev" title="Why My Grandma Can Recall 100+ Phone Numbers, But We Can't">Previous post</a>
            </li>
            <li class="next">
                <a href="../08/django-profile-optimize-views.html" rel="next" title="Profiling &amp; Optimizing Bottlenecks In Django">Next post</a>
            </li>
        </ul></nav></aside><div class="full-article-footer">
            <div class="article-footer">

                <div class="avatar-module">
                    <img class="avatar" height="100px" src="../../images/chillaranand.jpg">
</div>

                <p class="avatar-module">
                    Written by
                    <br><b>Chillar Anand</b>
                    <br>
                    Musings about programming, careers &amp; life.
                </p>

            </div>
        </div>

        <hr></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2020         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

            <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script src="../../assets/js/moment-with-locales.min.js"></script><script src="../../assets/js/fancydates.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
        }});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-81644162-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-81644162-1');

    $(document.links).filter(function() {
        return this.hostname != window.location.hostname;
    }).attr('target', '_blank');
    </script>
</body>
</html>
