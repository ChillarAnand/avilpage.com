<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Writing python code to modify code using Full Syntax Trees">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Refactoring Django With Full Syntax Tree | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="http://avilpage.com/2017/01/refactoring-django-with-fst.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="blog_posts_are_better_than_scientific_papers/" title="Why Blog Posts Are Better Than Scientific Papers?" type="text/html">
<link rel="next" href="../02/bmtc-exploiting-crores-from-bangalore-citizens.html" title="How BMTC Is Exploiting Crores From Bangalore Citizens?" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Refactoring Django With Full Syntax Tree">
<meta property="og:url" content="http://avilpage.com/2017/01/refactoring-django-with-fst.html">
<meta property="og:description" content="Writing python code to modify code using Full Syntax Trees">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-01-29T17:51:37Z">
<meta property="article:tag" content="django">
<meta property="article:tag" content="featured">
<meta property="article:tag" content="python">
<style>

 navbar, .body-content {
     margin-right: 20%;
     margin-left: 20%;
 }

 h1 {
     font-weight: bold;
     font-size: 25px;
 }

</style>
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

    <!-- Menubar -->

    <nav class="navbar navbar-expand-md static-top mb-4
                navbar-dark
                bg-dark
                "><div class="container">
<!-- This keeps the margins nice -->
            <a class="navbar-brand" href="../../">

                    <span id="blog-title">Avil Page</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="bs-navbar">
                <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../tags" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../p/talks.html" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="../../p/projects.html" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../p/pages.html" class="nav-link">Pages</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                    
                </li>
</ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="refactoring-django-with-fst.md" id="sourcelink" class="nav-link">Source</a>
    </li>

                    
                </ul>
</div>
<!-- /.navbar-collapse -->
        </div>
<!-- /.container -->
    </nav><!-- End of Menubar --><div class="container" id="content" role="main">
        <div class="body-content">
            <!--Body content-->
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Refactoring Django With Full Syntax Tree</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Chillar Anand
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2017-01-29T17:51:37Z" itemprop="datePublished" title="2017-01-29">2017-01-29</time></a>
            </p>
                    <p class="sourceline"><a href="refactoring-django-with-fst.md" class="sourcelink">Source</a></p>

        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Django developers decided to <a href="https://code.djangoproject.com/ticket/23919" target="_blank">drop Python 2 compatability</a> in Django 2.0. There are serveral things that should be refactored/removed.</p>
<p>For example, in Python 2, programmers has to explicitly specify the class &amp; instance when invoking <code>super</code>.</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>

<p>In Python 3, <code>super</code> can be invoked without arguments and it will choose right class &amp; instance automatically.</p>
<div class="code"><pre class="code literal-block"><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>

<p>For this refactoring, a simple <code>sed</code> search/replace should suffice. But, there are several hacks in codebase where super calls the grandparent instead of the parent. So, <code>sed</code> won't work in such cases. It is hard to refactor them manually and much harder for reviewers as there are 1364 super calls in code base.</p>
<div class="code"><pre class="code literal-block">→ grep -rI <span class="s2">"super("</span> <span class="p">|</span> wc -l
   <span class="m">1364</span>
</pre></div>

<p>So changes has to be scripted. A <a href="https://github.com/ChillarAnand/01/blob/master/python/super_exp.py" target="_blank">simple python script</a> to replace super calls by class names will fail to capture classes with on top of them, classes with decorators and nested classes.</p>
<p>To handle all these cases, this python script gets more complicated and there is no guarantee that it can handle all edge cases. So, a better choice is to use syntax trees.</p>
<p>Python has <a href="https://docs.python.org/3/library/ast.html" target="_blank">ast module</a> to convert code to AST but it can't convert AST back to code. There are 3rd party packages like <a href="https://pypi.python.org/pypi/astor" target="_blank">astor</a> which can do this.</p>
<div class="code"><pre class="code literal-block"><span class="c1"># this is a comment</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>

   <span class="nb">print</span><span class="p">(</span>
    <span class="s2">"hello world"</span>
<span class="p">)</span>
</pre></div>

<p>Converting above code to AST and then converting back gives this</p>
<div class="code"><pre class="code literal-block"><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'hello world'</span><span class="p">)</span>
</pre></div>

<p>Code to AST is a lossy transformation as they cannot preserve empty lines, comments and code formatting.</p>
<div class="code"><pre class="code literal-block"><span class="n">ast_to_code</span><span class="p">(</span><span class="n">code_to_ast</span><span class="p">(</span><span class="n">source_code</span><span class="p">))</span> <span class="o">!=</span> <span class="n">source_code</span>
</pre></div>

<p>For lossless transformation, FST(Full Syntax Trees) is needed.</p>
<div class="code"><pre class="code literal-block"><span class="n">fst_to_code</span><span class="p">(</span><span class="n">code_to_fst</span><span class="p">(</span><span class="n">source_code</span><span class="p">))</span> <span class="o">==</span> <span class="n">source_code</span>
</pre></div>

<p><a href="https://github.com/PyCQA/redbaron" target="_blank">RedBaron</a> package provides FST for given piece of code. With this, just locate super calls, find nearest class node, check class name with super and replace accordingly. With RedBaron, this refactoring can be done in <a href="https://github.com/ChillarAnand/01/blob/master/python/redbaron_super.py" target="_blank">less than 10 lines</a> of code.</p>
<p>RedBaron has good documentation with relveant examples and its API is similar to BeautifulSoup. To write code that modifies code RedBaron seems to be an apt choice.</p>
<p>Thanks to <a href="https://github.com/timgraham" target="_blank">Tim Graham</a> &amp; <a href="https://github.com/aaugustin" target="_blank">Aymeric Augustin</a> for <a href="https://github.com/django/django/pull/7905/commits/d6eaf7c0183cd04b78f2a55e1d60bb7e59598310" target="_blank">reviewing the patch</a>.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/django.html" rel="tag">django</a></li>
            <li><a class="tag p-category" href="../../tags/featured.html" rel="tag">featured</a></li>
            <li><a class="tag p-category" href="../../tags/python.html" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="blog_posts_are_better_than_scientific_papers/" rel="prev" title="Why Blog Posts Are Better Than Scientific Papers?">Previous post</a>
            </li>
            <li class="next">
                <a href="../02/bmtc-exploiting-crores-from-bangalore-citizens.html" rel="next" title="How BMTC Is Exploiting Crores From Bangalore Citizens?">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
                Contents © 2022         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
                
            </footer>
</div>
    </div>

                <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
