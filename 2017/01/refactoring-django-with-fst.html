<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Writing python code to modify code using Full Syntax Trees">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Refactoring Django With Full Syntax Tree | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<!-- <link href="/assets/css/rst_base.css" rel="stylesheet" type="text/css"> --><link href="../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/style.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/carbon.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://avilpage.com/2017/01/refactoring-django-with-fst.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="blog_posts_are_better_than_scientific_papers/" title="Why Blog Posts Are Better Than Scientific Papers?" type="text/html">
<link rel="next" href="../02/bmtc-exploiting-crores-from-bangalore-citizens.html" title="How BMTC Is Exploiting Crores From Bangalore Citizens?" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Refactoring Django With Full Syntax Tree">
<meta property="og:url" content="http://avilpage.com/2017/01/refactoring-django-with-fst.html">
<meta property="og:description" content="Writing python code to modify code using Full Syntax Trees">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-01-29T17:51:37Z">
<meta property="article:tag" content="django">
<meta property="article:tag" content="featured">
<meta property="article:tag" content="python">
<script data-ad-client="ca-pub-7483923329257191" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://avilpage.com/">

                <span id="blog-title">Avil Page</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../">Articles</a>
                </li>
<li>
<a href="../../p/talks.html">Talks</a>
                </li>
<li>
<a href="../../p/projects.html">Projects</a>
                </li>
<li>
<a href="../../p/pages.html">Pages</a>
                </li>
<li>
<a href="../../p/about.html">About</a>
                </li>
<li>
<a href="https://forms.gle/Hre4z4aLqJA5zYWe6">Contact</a>
                </li>
<li>
<a href="../../rss.xml">RSS</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
            <a href="refactoring-django-with-fst.md" id="sourcelink">Source</a>
        </li>
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content col-lg-6 col-lg-offset-3 col-xs-12 col-md-12">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
<div class="">
            <div class="">
                <div class="avatar-module">
                    <img class="avatar" src="../../images/chillaranand.jpg">
</div>

                <p class="avatar-module">
                    <b>Chillar Anand</b>

                    <a href="https://twitter.com/chillaranand" class="btn btn-social-icon btn-twitter" target="_blank">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-square-o fa-stack-2x"></i>
                            <i class="fa fa-twitter fa-stack-1x"></i>
                        </span>
                    </a>

                    <a href="https://www.facebook.com/com.avilpage" class="btn btn-social-icon btn-facebook" target="_blank">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-square-o fa-stack-2x"></i>
                            <i class="fa fa-facebook-square fa-stack-1x"></i>
                        </span>
                    </a>

                    <a href="https://www.youtube.com/channel/UC6kIM3av9m_ljSKrMgd8Z_A" class="btn btn-social-icon btn-youtube" target="_blank">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-square-o fa-stack-2x"></i>
                            <i class="fa fa-youtube-square fa-stack-1x"></i>
                        </span>
                    </a>


                    <br>
                    Musings about programming, careers &amp; life.
                </p>
            </div>
        </div>

        <hr>
<!--Body content--><div class="row">
            
    <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Refactoring Django With Full Syntax Tree</a></h1>

        <div class="metadata">
            <p class="dateline">
                <time class="published dt-published" datetime="2017-01-29T17:51:37Z" itemprop="datePublished" title="29 Jan 17">29 Jan 2017</time></p>
            |
            

        4 min read


        </div>
        
    </header><hr>
<div class="e-content entry-content" itemprop="articleBody text">
            <div>
<p>Django developers decided to <a href="https://code.djangoproject.com/ticket/23919" target="_blank">drop Python 2 compatability</a> in Django 2.0. There are serveral things that should be refactored/removed.</p>
<p>For example, in Python 2, programmers has to explicitly specify the class &amp; instance when invoking <code>super</code>.</p>
<pre class="code literal-block"><span></span><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</code></pre>

<p>In Python 3, <code>super</code> can be invoked without arguments and it will choose right class &amp; instance automatically.</p>
<pre class="code literal-block"><span></span><code><span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</code></pre>

<p>For this refactoring, a simple <code>sed</code> search/replace should suffice. But, there are several hacks in codebase where super calls the grandparent instead of the parent. So, <code>sed</code> won't work in such cases. It is hard to refactor them manually and much harder for reviewers as there are 1364 super calls in code base.</p>
<pre class="code literal-block"><span></span><code>→ grep -rI <span class="s2">"super("</span> <span class="p">|</span> wc -l
   <span class="m">1364</span>
</code></pre>

<p>So changes has to be scripted. A <a href="https://github.com/ChillarAnand/01/blob/master/python/super_exp.py" target="_blank">simple python script</a> to replace super calls by class names will fail to capture classes with on top of them, classes with decorators and nested classes.</p>
<p>To handle all these cases, this python script gets more complicated and there is no guarantee that it can handle all edge cases. So, a better choice is to use syntax trees.</p>
<p>Python has <a href="https://docs.python.org/3/library/ast.html" target="_blank">ast module</a> to convert code to AST but it can't convert AST back to code. There are 3rd party packages like <a href="https://pypi.python.org/pypi/astor" target="_blank">astor</a> which can do this.</p>
<pre class="code literal-block"><span></span><code><span class="c1"># this is a comment</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>

   <span class="nb">print</span><span class="p">(</span>
    <span class="s2">"hello world"</span>
<span class="p">)</span>
</code></pre>

<p>Converting above code to AST and then converting back gives this</p>
<pre class="code literal-block"><span></span><code><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'hello world'</span><span class="p">)</span>
</code></pre>

<p>Code to AST is a lossy transformation as they cannot preserve empty lines, comments and code formatting.</p>
<pre class="code literal-block"><span></span><code><span class="n">ast_to_code</span><span class="p">(</span><span class="n">code_to_ast</span><span class="p">(</span><span class="n">source_code</span><span class="p">))</span> <span class="o">!=</span> <span class="n">source_code</span>
</code></pre>

<p>For lossless transformation, FST(Full Syntax Trees) is needed.</p>
<pre class="code literal-block"><span></span><code><span class="n">fst_to_code</span><span class="p">(</span><span class="n">code_to_fst</span><span class="p">(</span><span class="n">source_code</span><span class="p">))</span> <span class="o">==</span> <span class="n">source_code</span>
</code></pre>

<p><a href="https://github.com/PyCQA/redbaron" target="_blank">RedBaron</a> package provides FST for given piece of code. With this, just locate super calls, find nearest class node, check class name with super and replace accordingly. With RedBaron, this refactoring can be done in <a href="https://github.com/ChillarAnand/01/blob/master/python/redbaron_super.py" target="_blank">less than 10 lines</a> of code.</p>
<p>RedBaron has good documentation with relveant examples and its API is similar to BeautifulSoup. To write code that modifies code RedBaron seems to be an apt choice.</p>
<p>Thanks to <a href="https://github.com/timgraham" target="_blank">Tim Graham</a> &amp; <a href="https://github.com/aaugustin" target="_blank">Aymeric Augustin</a> for <a href="https://github.com/django/django/pull/7905/commits/d6eaf7c0183cd04b78f2a55e1d60bb7e59598310" target="_blank">reviewing the patch</a>.</p>
</div>
        </div>
        <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/django.html" rel="tag">django</a></li>
            <li><a class="tag p-category" href="../../tags/featured.html" rel="tag">featured</a></li>
            <li><a class="tag p-category" href="../../tags/python.html" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="blog_posts_are_better_than_scientific_papers/" rel="prev" title="Why Blog Posts Are Better Than Scientific Papers?">Previous post</a>
            </li>
            <li class="next">
                <a href="../02/bmtc-exploiting-crores-from-bangalore-citizens.html" rel="next" title="How BMTC Is Exploiting Crores From Bangalore Citizens?">Next post</a>
            </li>
        </ul></nav></aside><!-- <div class="full-article-footer">
             <div class="article-footer">

             <div class="avatar-module">
             <img class="avatar" height="100px" src="/images/chillaranand.jpg">
             </div>

             <p class="avatar-module">
             Written by
             <br>
             <b>Chillar Anand</b>
             <br>
             Musings about programming, careers & life.
             </p>

             </div>
             </div> --><hr></article>
</div>
        <!--End of body content-->
        <div id="coral_thread"></div>

        <footer id="footer">
            Contents © 2021         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

            <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script src="../../assets/js/moment-with-locales.min.js"></script><script src="../../assets/js/fancydates.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
        }});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-81644162-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-81644162-1');

    $(document.links).filter(function() {
        return this.hostname != window.location.hostname;
    }).attr('target', '_blank');
    </script><!-- <script>
         (function() {
         var d = document, s = d.createElement('script');
         var url = 'avilpage-coral.herokuapp.com';
         /*         var url = 'http://comments.avilpage.com'; */
         s.src = '//' + url + '/assets/js/embed.js';
         s.async = false;
         s.defer = true;
         s.onload = function() {
         Coral.createStreamEmbed({
         id: "coral_thread",
         autoRender: true,
         rootURL: '//' + url,
         });
         };
         (d.head || d.body).appendChild(s);
         })();
         </script> -->
</body>
</html>
