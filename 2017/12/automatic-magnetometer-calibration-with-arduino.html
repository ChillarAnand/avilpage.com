<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Automatic Magnetometer Calibration With Arduino | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<!-- <link href="/assets/css/rst_base.css" rel="stylesheet" type="text/css"> --><link href="../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/style.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/carbon.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://avilpage.com/2017/12/automatic-magnetometer-calibration-with-arduino.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../11/django-tricks-auto-register-models-admin.html" title="Django Tips &amp; Tricks #9 - Auto Register Models In Admin" type="text/html">
<link rel="next" href="../../2018/01/how-to-plot-renko-charts-with-python.html" title="How To Plot Renko Charts With Python?" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Automatic Magnetometer Calibration With Arduino">
<meta property="og:url" content="http://avilpage.com/2017/12/automatic-magnetometer-calibration-with-arduino.html">
<meta property="og:description" content="If we take readings from a 3-axis magnetometers like HMC5883L, AK8963C (used in MPU9250) or LSM303DLHC and plot them, its response should be a sphere with ceter at origin.
In practice, due to the pres">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-12-02T21:21:21Z">
<meta property="article:tag" content="arduino">
<meta property="article:tag" content="how-to">
<script data-ad-client="ca-pub-7483923329257191" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://avilpage.com/">

                <span id="blog-title">Avil Page</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../">Articles</a>
                </li>
<li>
<a href="../../p/talks.html">Talks</a>
                </li>
<li>
<a href="../../p/projects.html">Projects</a>
                </li>
<li>
<a href="../../p/pages.html">Pages</a>
                </li>
<li>
<a href="../../p/about.html">About</a>
                </li>
<li>
<a href="../../rss.xml">RSS</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
            <a href="automatic-magnetometer-calibration-with-arduino.md" id="sourcelink">Source</a>
        </li>
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content col-lg-6 col-lg-offset-3 col-xs-12 col-md-12">
        <!--Body content-->
        <div class="row">
            
    <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Automatic Magnetometer Calibration With Arduino</a></h1>

        <div class="metadata">
            <p class="dateline">
                <time class="published dt-published" datetime="2017-12-02T21:21:21Z" itemprop="datePublished" title="02 Dec 17">02 Dec 2017</time></p>
            |
            

        5 min read


        </div>
        
    </header><hr>
<div class="e-content entry-content" itemprop="articleBody text">
            <div>
<p>If we take readings from a 3-axis <a href="https://en.wikipedia.org/wiki/Magnetometer">magnetometers</a> like HMC5883L, AK8963C (used in MPU9250) or LSM303DLHC and plot them, its response should be a sphere with ceter at origin.</p>
<p>In practice, due to the presence of hard and soft iron distortions, the response will be an ellipsiod with its center shifted away from origin. We need to calibrate the magnetometer to nullify the distortions.</p>
<p>First we need to get sample readings of magnetometer in various positions. Depending on the magnetometer, we need to connect it to arduino and take readings by rotating it in 8 shape.</p>
<h4>Calibration</h4>
<p>Hard iron biases shifts center away from origin. We can eliminate this error by calculating the offsets and shifting the readings.</p>
<pre class="code literal-block"><span></span><span class="kt">int</span> <span class="n">mx</span><span class="p">,</span> <span class="n">my</span><span class="p">,</span> <span class="n">mz</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">mx_min</span><span class="p">,</span> <span class="n">my_min</span><span class="p">,</span> <span class="n">mz_min</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">mx_max</span><span class="p">,</span> <span class="n">my_max</span><span class="p">,</span> <span class="n">mz_max</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">mx_offset</span><span class="p">,</span> <span class="n">my_offset</span><span class="p">,</span> <span class="n">mz_offset</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">mx_calibrated</span><span class="p">,</span> <span class="n">my_calibrated</span><span class="p">,</span> <span class="n">mz_calibrated</span><span class="p">;</span>

<span class="c1">// get min/max values by taking readings</span>
<span class="c1">// from magnetometer of your choice</span>

<span class="n">mx_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">mx_min</span> <span class="o">+</span> <span class="n">mx_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">my_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_min</span> <span class="o">+</span> <span class="n">my_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">mz_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">mz_min</span> <span class="o">+</span> <span class="n">mz_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

<span class="n">mx_calibrated</span> <span class="o">=</span> <span class="n">mx</span> <span class="o">-</span> <span class="n">mx_offset</span><span class="p">;</span>
<span class="n">my_calibrated</span> <span class="o">=</span> <span class="n">my</span> <span class="o">-</span> <span class="n">my_offset</span><span class="p">;</span>
<span class="n">mz_calibrated</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">mz_offset</span><span class="p">;</span>
</pre>


<p>Soft iron biases makes the axial responses uneven which results in ellipsiod shape. An easier way to correct this is to rescale the axial readings to an average value.</p>
<pre class="code literal-block"><span></span><span class="kt">int</span> <span class="n">mx_scale</span><span class="p">,</span> <span class="n">my_scale</span><span class="p">,</span> <span class="n">mz_scale</span><span class="p">;</span>

<span class="n">mx_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">mx_max</span> <span class="o">-</span> <span class="n">mx_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">my_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_max</span> <span class="o">-</span> <span class="n">my_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">mz_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">mz_max</span> <span class="o">-</span> <span class="n">mz_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

<span class="kt">float</span> <span class="n">avg_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">mx_scale</span> <span class="o">+</span> <span class="n">my_scale</span> <span class="o">+</span> <span class="n">mz_scale</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>

<span class="n">mx_calibrated</span> <span class="o">=</span> <span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">mx</span> <span class="o">-</span> <span class="n">mx_offset</span><span class="p">);</span>
<span class="n">my_calibrated</span> <span class="o">=</span> <span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">my</span> <span class="o">-</span> <span class="n">my_offset</span><span class="p">);</span>
<span class="n">mz_calibrated</span> <span class="o">=</span> <span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">mz</span> <span class="o">-</span> <span class="n">mz_offset</span><span class="p">);</span>
</pre>


<p>We can caclulate these biases once and store them in our code so that we don't need to calibrate it everytime. We can also write an auto update function which will recalibrate offsets &amp; scale for every new reading.</p>
</div>
        </div>
        <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/arduino.html" rel="tag">arduino</a></li>
            <li><a class="tag p-category" href="../../tags/how-to.html" rel="tag">how-to</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../11/django-tricks-auto-register-models-admin.html" rel="prev" title="Django Tips &amp; Tricks #9 - Auto Register Models In Admin">Previous post</a>
            </li>
            <li class="next">
                <a href="../../2018/01/how-to-plot-renko-charts-with-python.html" rel="next" title="How To Plot Renko Charts With Python?">Next post</a>
            </li>
        </ul></nav></aside><div class="full-article-footer">
            <div class="article-footer">

                <div class="avatar-module">
                    <img class="avatar" height="100px" src="../../images/chillaranand.jpg">
</div>

                <p class="avatar-module">
                    Written by
                    <br><b>Chillar Anand</b>
                    <br>
                    Musings about programming, careers &amp; life.
                </p>

            </div>
        </div>

        <hr></article>
</div>
        <!--End of body content-->
        <div id="coral_thread"></div>

        <footer id="footer">
            Contents © 2020         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

            <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script src="../../assets/js/moment-with-locales.min.js"></script><script src="../../assets/js/fancydates.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
        }});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-81644162-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-81644162-1');

    $(document.links).filter(function() {
        return this.hostname != window.location.hostname;
    }).attr('target', '_blank');
    </script><!-- <script>
         (function() {
         var d = document, s = d.createElement('script');
         var url = 'avilpage-coral.herokuapp.com';
         /*         var url = 'http://comments.avilpage.com'; */
         s.src = '//' + url + '/assets/js/embed.js';
         s.async = false;
         s.defer = true;
         s.onload = function() {
         Coral.createStreamEmbed({
         id: "coral_thread",
         autoRender: true,
         rootURL: '//' + url,
         });
         };
         (d.head || d.body).appendChild(s);
         })();
         </script> -->
</body>
</html>
