<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="author" content="Chillar Anand">
<title>Automatic Magnetometer Calibration With Arduino | Avil Page</title>
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/style.css" rel="stylesheet" type="text/css">
<link rel="canonical" href="http://www.avilpage.com/2017/12/automatic-magnetometer-calibration-with-arduino.html">
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<style>
     #wrapper {
         width: 100%;
         margin: 0;
     }

     #first-div {
         width: 16%;
         height: 90px;
         /*          margin: 10px 0px 0px 10px; */
         margin: 0;
         float: left ;
     }

     #second-div {
         width: 84%;
         height: 72px;
         margin: 18px 0px 0px 0px;
         float: left ;
     }
    </style>
</head>
<body>
        <div id="">
            <div id="container">
                <!-- <h1 id="blog-title">
                     <a href="http://www.avilpage.com/" title="Avil Page" rel="home">Avil Page</a>
                     </h1> -->




    <div class="postbox">

        <article class="postbox post-text"><div class="h-entry" itemscope="itemscope" itemtype="http://schema.org/Article">
                    <h1 class="p-name" itemprop="headline name">Automatic Magnetometer Calibration With Arduino</h1>




                4 min read


                <hr>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- avilpage.com top --><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8127755709093749" data-ad-slot="6914930471" data-ad-format="auto"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script><div class="e-content" itemprop="articleBody text">
                    <div>
<p>If we take readings from a 3-axis <a href="https://en.wikipedia.org/wiki/Magnetometer">magnetometers</a> like HMC5883L, AK8963C (used in MPU9250) or LSM303DLHC and plot them, its response should be a sphere with ceter at origin.</p>
<p>In practice, due to the presence of hard and soft iron distortions, the response will be an ellipsiod with its center shifted away from origin. We need to calibrate the magnetometer to nullify the distortions.</p>
<p>First we need to get sample readings of magnetometer in various positions. Depending on the magnetometer, we need to connect it to arduino and take readings by rotating it in 8 shape.</p>
<h4>Calibration</h4>
<p>Hard iron biases shifts center away from origin. We can eliminate this error by calculating the offsets and shifting the readings.</p>
<pre class="code literal-block"><span></span><span class="kt">int</span> <span class="n">mx</span><span class="p">,</span> <span class="n">my</span><span class="p">,</span> <span class="n">mz</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">mx_min</span><span class="p">,</span> <span class="n">my_min</span><span class="p">,</span> <span class="n">mz_min</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">mx_max</span><span class="p">,</span> <span class="n">my_max</span><span class="p">,</span> <span class="n">mz_max</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">mx_offset</span><span class="p">,</span> <span class="n">my_offset</span><span class="p">,</span> <span class="n">mz_offset</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">mx_calibrated</span><span class="p">,</span> <span class="n">my_calibrated</span><span class="p">,</span> <span class="n">mz_calibrated</span><span class="p">;</span>

<span class="c1">// get min/max values by taking readings</span>
<span class="c1">// from magnetometer of your choice</span>

<span class="n">mx_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">mx_min</span> <span class="o">+</span> <span class="n">mx_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">my_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_min</span> <span class="o">+</span> <span class="n">my_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">mz_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">mz_min</span> <span class="o">+</span> <span class="n">mz_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

<span class="n">mx_calibrated</span> <span class="o">=</span> <span class="n">mx</span> <span class="o">-</span> <span class="n">mx_offset</span><span class="p">;</span>
<span class="n">my_calibrated</span> <span class="o">=</span> <span class="n">my</span> <span class="o">-</span> <span class="n">my_offset</span><span class="p">;</span>
<span class="n">mz_calibrated</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">-</span> <span class="n">mz_offset</span><span class="p">;</span>
</pre>


<p>Soft iron biases makes the axial responses uneven which results in ellipsiod shape. An easier way to correct this is to rescale the axial readings to an average value.</p>
<pre class="code literal-block"><span></span><span class="kt">int</span> <span class="n">mx_scale</span><span class="p">,</span> <span class="n">my_scale</span><span class="p">,</span> <span class="n">mz_scale</span><span class="p">;</span>

<span class="n">mx_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">mx_max</span> <span class="o">-</span> <span class="n">mx_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">my_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_max</span> <span class="o">-</span> <span class="n">my_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">mz_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">mz_max</span> <span class="o">-</span> <span class="n">mz_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

<span class="kt">float</span> <span class="n">avg_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">mx_scale</span> <span class="o">+</span> <span class="n">my_scale</span> <span class="o">+</span> <span class="n">mz_scale</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>

<span class="n">mx_calibrated</span> <span class="o">=</span> <span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">mx</span> <span class="o">-</span> <span class="n">mx_offset</span><span class="p">);</span>
<span class="n">my_calibrated</span> <span class="o">=</span> <span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">my</span> <span class="o">-</span> <span class="n">my_offset</span><span class="p">);</span>
<span class="n">mz_calibrated</span> <span class="o">=</span> <span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">mz</span> <span class="o">-</span> <span class="n">mz_offset</span><span class="p">);</span>
</pre>


<p>We can caclulate these biases once and store them in our code so that we don't need to calibrate it everytime. We can also write an auto update function which will recalibrate offsets &amp; scale for every new reading.</p>
</div>
                </div>

            </div>

                <b> Tags: </b>
                    <a href="../../tags/arduino.html">arduino</a>
                        |
                    <a href="../../tags/how-to.html">how-to</a>

            <br><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- avilpage.com bottom --><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8127755709093749" data-ad-slot="5818660596" data-ad-format="auto"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script><hr>
<div id="wrapper">
                <div id="first-div">
                    <img src="https://s.gravatar.com/avatar/608fa09693cef8d410834bd55755dbed?s=80">
</div>
                <div id="second-div">
                    I am Chillar Anand. I daydream a lot and write about the things that interest me here.
                    You can read more about <a href="../../p/about-avilpage.html">this blog here</a>.
                </div>
            </div>

            <hr>
<a href="../../">
                <h2>See all articles</h2>
            </a>

            <a href="../../rss.xml">
                <h3>RSS Feed for the blog</h3>
            </a>

            <a href="https://github.com/ChillarAnand/avilpage.com">
                Edit this page
            </a>

            <hr></article>
</div>


                <br>
</div>


            <!--Sidebar content-->
            <!-- <ul class="unstyled">
                     

                                 <li><a href="/">Articles</a>
                <li><a href="/about">About.html</a>
                <li><a href="/rss.xml">RSS</a>

                 </ul> -->
            <br>
</div>
    </body>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                             m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81644162-1', 'auto');
    ga('send', 'pageview');

    </script>
</html>
