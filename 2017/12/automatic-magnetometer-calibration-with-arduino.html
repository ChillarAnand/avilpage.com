<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Automatic Magnetometer Calibration With Arduino | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://avilpage.com/2017/12/automatic-magnetometer-calibration-with-arduino.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../11/django-tricks-auto-register-models-admin.html" title="Django Tips &amp; Tricks #9 - Auto Register Models In Admin" type="text/html">
<link rel="next" href="../../2018/01/how-to-plot-renko-charts-with-python.html" title="How To Plot Renko Charts With Python?" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Automatic Magnetometer Calibration With Arduino">
<meta property="og:url" content="https://avilpage.com/2017/12/automatic-magnetometer-calibration-with-arduino.html">
<meta property="og:description" content="If we take readings from a 3-axis magnetometers like HMC5883L, AK8963C (used in MPU9250) or LSM303DLHC and plot them, its response should be a sphere with ceter at origin.
In practice, due to the pres">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-12-02T21:21:21Z">
<meta property="article:tag" content="arduino">
<meta property="article:tag" content="how-to">
<style>

 h1 {
     font-weight: bold;
     font-size: 25px;
 }

</style>
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

    <!-- Menubar -->
    <nav class="navbar navbar-expand-md static-top mb-4
                navbar-dark
                bg-dark
                "><div class="container">
<!-- This keeps the margins nice -->
            <a class="navbar-brand" href="../../">

                    <span id="blog-title">Avil Page</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="bs-navbar">
                <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../top-10.html" class="nav-link">Top 10</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Articles</a>
                </li>
<li class="nav-item">
<a href="../../p/projects.html" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                    
                </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
        </div>
<!-- /.container -->
    </nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="row justify-content-md-center">
        <div class="body-content col col-lg-6">
            <!--Body content-->
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Automatic Magnetometer Calibration With Arduino</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Chillar Anand
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2017-12-02T21:21:21Z" itemprop="datePublished" title="2017-12-02">2017-12-02</time></a>
            </p>
                    <p class="sourceline"><a href="automatic-magnetometer-calibration-with-arduino.md" class="sourcelink">Source</a></p>

        </div>
        
    </header>


    

        7 min read



    <div class="e-content entry-content" itemprop="articleBody text">
    <p>If we take readings from a 3-axis <a href="https://en.wikipedia.org/wiki/Magnetometer">magnetometers</a> like HMC5883L, AK8963C (used in MPU9250) or LSM303DLHC and plot them, its response should be a sphere with ceter at origin.</p>
<p>In practice, due to the presence of hard and soft iron distortions, the response will be an ellipsiod with its center shifted away from origin. We need to calibrate the magnetometer to nullify the distortions.</p>
<p>First we need to get sample readings of magnetometer in various positions. Depending on the magnetometer, we need to connect it to arduino and take readings by rotating it in 8 shape.</p>
<h4>Calibration</h4>
<p>Hard iron biases shifts center away from origin. We can eliminate this error by calculating the offsets and shifting the readings.</p>
<div class="code"><pre class="code literal-block"><span class="kt">int</span><span class="w"> </span><span class="n">mx</span><span class="p">,</span><span class="w"> </span><span class="n">my</span><span class="p">,</span><span class="w"> </span><span class="n">mz</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">mx_min</span><span class="p">,</span><span class="w"> </span><span class="n">my_min</span><span class="p">,</span><span class="w"> </span><span class="n">mz_min</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">mx_max</span><span class="p">,</span><span class="w"> </span><span class="n">my_max</span><span class="p">,</span><span class="w"> </span><span class="n">mz_max</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">mx_offset</span><span class="p">,</span><span class="w"> </span><span class="n">my_offset</span><span class="p">,</span><span class="w"> </span><span class="n">mz_offset</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">mx_calibrated</span><span class="p">,</span><span class="w"> </span><span class="n">my_calibrated</span><span class="p">,</span><span class="w"> </span><span class="n">mz_calibrated</span><span class="p">;</span><span class="w"></span>

<span class="c1">// get min/max values by taking readings</span>
<span class="c1">// from magnetometer of your choice</span>

<span class="n">mx_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mx_min</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mx_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">my_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">my_min</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">my_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">mz_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mz_min</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mz_max</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="n">mx_calibrated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mx_offset</span><span class="p">;</span><span class="w"></span>
<span class="n">my_calibrated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">my_offset</span><span class="p">;</span><span class="w"></span>
<span class="n">mz_calibrated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mz_offset</span><span class="p">;</span><span class="w"></span>
</pre></div>

<p>Soft iron biases makes the axial responses uneven which results in ellipsiod shape. An easier way to correct this is to rescale the axial readings to an average value.</p>
<div class="code"><pre class="code literal-block"><span class="kt">int</span><span class="w"> </span><span class="n">mx_scale</span><span class="p">,</span><span class="w"> </span><span class="n">my_scale</span><span class="p">,</span><span class="w"> </span><span class="n">mz_scale</span><span class="p">;</span><span class="w"></span>

<span class="n">mx_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mx_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mx_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">my_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">my_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">my_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">mz_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mz_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mz_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="kt">float</span><span class="w"> </span><span class="n">avg_scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mx_scale</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">my_scale</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mz_scale</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span><span class="w"></span>

<span class="n">mx_calibrated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">mx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mx_offset</span><span class="p">);</span><span class="w"></span>
<span class="n">my_calibrated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">my</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">my_offset</span><span class="p">);</span><span class="w"></span>
<span class="n">mz_calibrated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avg_scale</span><span class="o">/</span><span class="p">(</span><span class="n">mz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mz_offset</span><span class="p">);</span><span class="w"></span>
</pre></div>

<p>We can caclulate these biases once and store them in our code so that we don't need to calibrate it everytime. We can also write an auto update function which will recalibrate offsets &amp; scale for every new reading.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/arduino.html" rel="tag">arduino</a></li>
            <li><a class="tag p-category" href="../../tags/how-to.html" rel="tag">how-to</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../11/django-tricks-auto-register-models-admin.html" rel="prev" title="Django Tips &amp; Tricks #9 - Auto Register Models In Admin">Previous post</a>
            </li>
            <li class="next">
                <a href="../../2018/01/how-to-plot-renko-charts-with-python.html" rel="next" title="How To Plot Renko Charts With Python?">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
                Contents Â© 2022         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
                
            </footer>
</div>
    </div>
    </div>

                <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
