<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Cache responses from external APIs for writing better integration tests.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Reliable Way To Test External APIs Without Mocking | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/bootblog.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="http://avilpage.com/2018/04/reliable-way-to-test-external-apis-without-mocking.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../03/convert-browser-requests-to-python-requests.html" title="Convert Browser Requests To Python Requests For Scraping" type="text/html">
<link rel="next" href="../05/deploying-scaling-django-channels.html" title="How To Deploy Django Channels To Production" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Reliable Way To Test External APIs Without Mocking">
<meta property="og:url" content="http://avilpage.com/2018/04/reliable-way-to-test-external-apis-without-mocking.html">
<meta property="og:description" content="Cache responses from external APIs for writing better integration tests.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-04-08T21:21:21+05:30">
<meta property="article:tag" content="django">
<meta property="article:tag" content="python">
<meta property="article:tag" content="testing">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Avil Page</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="reliable-way-to-test-external-apis-without-mocking.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../" class="nav-link">Articles</a>
                </li>
<li class="nav-item">
<a href="../../p/talks.html" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="../../p/projects.html" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../p/pages.html" class="nav-link">Pages</a>
                </li>
<li class="nav-item">
<a href="../../p/about.html" class="nav-link">About</a>
                </li>
<li class="nav-item">
<a href="https://forms.gle/Hre4z4aLqJA5zYWe6" class="nav-link">Contact</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Reliable Way To Test External APIs Without Mocking</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Chillar Anand
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2018-04-08T21:21:21+05:30" itemprop="datePublished" title="2018-04-08">2018-04-08</time></a>
            </p>
            
        <p class="sourceline"><a href="reliable-way-to-test-external-apis-without-mocking.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Let us write a function which retrieves user information from GitHub API.</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">get_github_user_info</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'https://api.github.com/users/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s1">'</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>

<p>To test this function, we can write a test case to call the external API and check if it is returning valid data.</p>
<div class="code"><pre class="code literal-block"><span class="k">def</span> <span class="nf">test_get_github_user_info</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s1">'ChillarAnand'</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">get_github_user_info</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s1">'login'</span><span class="p">]</span>
</pre></div>

<p>Even though this test case is reliable, this won't be efficient when we have many APIs to test as it sends unwanted requests to external API and makes tests slower due to I/O.</p>
<p>A widely used solution to avoid external API calls is <a href="https://en.wikipedia.org/wiki/Mock_object">mocking</a>. Instead of getting the response from external API, use a mock object which returns similar data.</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>


<span class="k">def</span> <span class="nf">test_get_github_user_info_with_mock</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">'requests.get'</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="s1">'ChillarAnand'</span>

        <span class="n">mock_get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">json_response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"login"</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
        <span class="n">mock_get</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">json_response</span>

        <span class="n">info</span> <span class="o">=</span> <span class="n">get_github_user_info</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s1">'login'</span><span class="p">]</span>
</pre></div>

<p>This solves above problems but creates additional problems.</p>
<ul>
<li>Unreliable. Even though test cases pass, we are not sure if API is up and is returning a valid response.</li>
<li>Maintenance. We need to ensure mock responses are up to date with API.</li>
</ul>
<p>To avoid this, we can cache the responses using <a href="https://pypi.python.org/pypi/requests-cache">requests-cache</a>.</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">requests_cache</span>

<span class="n">requests_cache</span><span class="o">.</span><span class="n">install_cache</span><span class="p">(</span><span class="s1">'github_cache'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_get_github_user_info_without_mock</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s1">'ChillarAnand'</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">get_github_user_info</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s1">'login'</span><span class="p">]</span>
</pre></div>

<p>When running tests from developer machine, it will call the API for the first time and uses the cached response for subsequent API calls. On CI pipeline, it will hit the external API as there won't be any cache.</p>
<p>When the response from external API changes, we need to invalidate the cache. Even if we miss cache invalidation, test cases will fail in CI pipeline before going into production.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/django.html" rel="tag">django</a></li>
            <li><a class="tag p-category" href="../../tags/python.html" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../tags/testing.html" rel="tag">testing</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../03/convert-browser-requests-to-python-requests.html" rel="prev" title="Convert Browser Requests To Python Requests For Scraping">Previous post</a>
            </li>
            <li class="next">
                <a href="../05/deploying-scaling-django-channels.html" rel="next" title="How To Deploy Django Channels To Production">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


            <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
