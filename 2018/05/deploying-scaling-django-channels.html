<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How To Deploy Django Channels To Production | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<!-- <link href="/assets/css/rst_base.css" rel="stylesheet" type="text/css"> --><link href="../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/style.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/carbon.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="http://avilpage.com/2018/05/deploying-scaling-django-channels.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../04/reliable-way-to-test-external-apis-without-mocking.html" title="Reliable Way To Test External APIs Without Mocking" type="text/html">
<link rel="next" href="django-tips-tricks-log-sql-queries-to-console.html" title="Django Tips &amp; Tricks #10 - Log SQL Queries To Console" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="How To Deploy Django Channels To Production">
<meta property="og:url" content="http://avilpage.com/2018/05/deploying-scaling-django-channels.html">
<meta property="og:description" content="In this article, we will see how to deploy django channels to production and how we can scale it to handle more load. We will be using nginx as proxy server, daphne as ASGI server, gunicorn as WSGI se">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-05-18T21:21:21+05:30">
<meta property="article:tag" content="devops">
<meta property="article:tag" content="django">
<meta property="article:tag" content="featured">
<meta property="article:tag" content="python">
<script data-ad-client="ca-pub-7483923329257191" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-fixed-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://avilpage.com/">

                <span id="blog-title">Avil Page</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../">Articles</a>
                </li>
<li>
<a href="../../p/talks.html">Talks</a>
                </li>
<li>
<a href="../../p/projects.html">Projects</a>
                </li>
<li>
<a href="../../p/pages.html">Pages</a>
                </li>
<li>
<a href="../../p/about.html">About</a>
                </li>
<li>
<a href="../../rss.xml">RSS</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
            <a href="deploying-scaling-django-channels.md" id="sourcelink">Source</a>
        </li>
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content col-lg-6 col-lg-offset-3 col-xs-12 col-md-12">
        <!--Body content-->
        <div class="row">
            
    <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">How To Deploy Django Channels To Production</a></h1>

        <div class="metadata">
            <p class="dateline">
                <time class="published dt-published" datetime="2018-05-18T21:21:21+05:30" itemprop="datePublished" title="18 May 18">18 May 2018</time></p>
            |
            

        8 min read


        </div>
        
    </header><hr>
<div class="e-content entry-content" itemprop="articleBody text">
            <div>
<p>In this article, we will see how to deploy <a href="https://pypi.org/project/channels/">django channels</a> to production and how we can scale it to handle more load. We will be using nginx as proxy server, <a href="https://pypi.org/project/daphne/">daphne</a> as ASGI server, gunicorn as WSGI server and redis for channel back-end.</p>
<p>Daphne can serve HTTP requests as well as WebSocket requests. For stability and performance, we will use uwsgi/gunicorn to serve HTTP requests and daphne to serve websocket requests.</p>
<p>We will be using systemd to create and manage processes instead of depending on third party process managers like supervisor or circus. We will be using ansible for managing deployments. If you don't want to use ansible, you can just replace template variables in the following files with actual values.</p>
<h4>Nginx Setup</h4>
<p>Nginx will be routing requests to WSGI server and ASGI server based on URL. Here is nginx configuration for server.</p>
<pre class="code literal-block"><span></span><span class="x">server {</span>
<span class="x">    listen </span><span class="cp">{{</span> <span class="nv">server_name</span> <span class="cp">}}</span><span class="x">:80;</span>
<span class="x">    server_name </span><span class="cp">{{</span> <span class="nv">server_name</span> <span class="cp">}}</span><span class="x"> www.</span><span class="cp">{{</span> <span class="nv">server_name</span> <span class="cp">}}</span><span class="x">;</span>

<span class="x">    return 301 https://avilpage.com$request_uri;</span>
<span class="x">}</span>


<span class="x">server {</span>
<span class="x">    listen </span><span class="cp">{{</span> <span class="nv">server_name</span> <span class="cp">}}</span><span class="x">:443 ssl;</span>
<span class="x">    server_name </span><span class="cp">{{</span> <span class="nv">server_name</span> <span class="cp">}}</span><span class="x"> www.</span><span class="cp">{{</span> <span class="nv">server_name</span> <span class="cp">}}</span><span class="x">;</span>

<span class="x">    ssl_certificate     /root/certs/avilpage.com.chain.crt;</span>
<span class="x">    ssl_certificate_key /root/certs/avilpage.com.key;</span>

<span class="x">    access_log /var/log/nginx/avilpage.com.access.log;</span>
<span class="x">    error_log /var/log/nginx/avilpage.com.error.log;</span>

<span class="x">    location / {</span>
<span class="x">            proxy_pass http://0.0.0.0:8000;</span>
<span class="x">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
<span class="x">            proxy_set_header Host $http_host;</span>
<span class="x">            proxy_set_header X-Real-IP $remote_addr;</span>
<span class="x">            proxy_redirect off;</span>
<span class="x">    }</span>

<span class="x">    location /ws/ {</span>
<span class="x">            proxy_pass http://0.0.0.0:9000;</span>
<span class="x">            proxy_http_version 1.1;</span>

<span class="x">            proxy_read_timeout 86400;</span>
<span class="x">            proxy_redirect     off;</span>

<span class="x">            proxy_set_header Upgrade $http_upgrade;</span>
<span class="x">            proxy_set_header Connection "upgrade";</span>
<span class="x">            proxy_set_header Host $host;</span>
<span class="x">            proxy_set_header X-Real-IP $remote_addr;</span>
<span class="x">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
<span class="x">            proxy_set_header X-Forwarded-Host $server_name;</span>
<span class="x">    }</span>

<span class="x">    location /static {</span>
<span class="x">        alias </span><span class="cp">{{</span> <span class="nv">project_root</span> <span class="cp">}}</span><span class="x">/static;</span>
<span class="x">    }</span>

<span class="x">    location  /favicon.ico {</span>
<span class="x">        alias </span><span class="cp">{{</span> <span class="nv">project_root</span> <span class="cp">}}</span><span class="x">//static/img/favicon.ico;</span>
<span class="x">    }</span>

<span class="x">    location  /robots.txt {</span>
<span class="x">        alias </span><span class="cp">{{</span> <span class="nv">project_root</span> <span class="cp">}}</span><span class="x">/static/txt/robots.txt;</span>
<span class="x">    }</span>

<span class="x">}</span>
</pre>


<h4>WSGI Server Setup</h4>
<p>We will use gunicorn for wsgi server. We can run gunicorn with</p>
<pre class="code literal-block"><span></span>$ gunicorn avilpage.wsgi --bind <span class="m">0</span>.0.0.0:8000 --log-level error --log-file<span class="o">=</span>- --settings avilpage.production_settings
</pre>


<p>We can create a systemd unit file to make it as a service.</p>
<pre class="code literal-block"><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">gunicorn</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>


<span class="k">[Service]</span>
<span class="na">PIDFile</span><span class="o">=</span><span class="s">/run/gunicorn/pid</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">Group</span><span class="o">=</span><span class="s">root</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">{{ project_root }}</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">"DJANGO_SETTINGS_MODULE={{ project_name }}.production_settings"</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">{{ venv_bin }}/gunicorn {{ project_name}}.wsgi --bind 0.0.0.0:8000 --log-level error --log-file=- --workers 5 --preload</span>


<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -s HUP $MAINPID</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/kill -s TERM $MAINPID</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-abort</span>
<span class="na">PrivateTmp</span><span class="o">=</span><span class="s">true</span>


<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre>


<p>Whenever server restarts, systemd will automatically start gunicorn service. We can also restart gunicorn manually with</p>
<pre class="code literal-block"><span></span>$ sudo service gunicorn restart
</pre>


<h4>ASGI Server Setup</h4>
<p>We will use daphne for ASGI server and it can be started with</p>
<pre class="code literal-block"><span></span>$ daphne avilpage.asgi:application --bind <span class="m">0</span>.0.0.0 --port <span class="m">9000</span> --verbosity <span class="m">1</span>
</pre>


<p>We can create a systemd unit file like the previous one to create a service.</p>
<pre class="code literal-block"><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">daphne daemon</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>


<span class="k">[Service]</span>
<span class="na">PIDFile</span><span class="o">=</span><span class="s">/run/daphne/pid</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">Group</span><span class="o">=</span><span class="s">root</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">{{ project_root }}</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">"DJANGO_SETTINGS_MODULE={{ project_name }}.production_settings"</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">{{ venv_bin }}/daphne --bind 0.0.0.0 --port 9000 --verbosity 0 {{project_name}}.asgi:application</span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -s HUP $MAINPID</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/kill -s TERM $MAINPID</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-abort</span>
<span class="na">PrivateTmp</span><span class="o">=</span><span class="s">true</span>


<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre>


<h4>Deployment</h4>
<p>Here is <a href="https://github.com/ChillarAnand/eddie/blob/master/ubuntu/config/playbooks/django_setup.yml">an ansible playbook</a> which is used to deploy these config files to our server. To run the playbook on server <code>avilpage.com</code>, execute</p>
<pre class="code literal-block"><span></span>$ ansible-playbook -i avilpage.com, django_setup.yml
</pre>


<h4>Scaling</h4>
<p>Now that we have deployed channels to production, we can do performance test to see how our server performs under load.</p>
<p>For WebSockets, we can use <a href="https://www.npmjs.com/package/thor">Thor</a> to run performance test.</p>
<pre class="code literal-block"><span></span>thor -C <span class="m">100</span> -A <span class="m">1000</span> wss://avilpage.com/ws/books/
</pre>


<p>Our server is able to handle <code>100 requests per second</code> with a <code>latency of 800ms</code>. This is good enough for low traffic website.</p>
<p>To improve performance, we can use unix sockets instead of rip/port for gunicorn and daphne. Also, daphne has support for multiprocessing using <a href="#">shared file descriptors</a>. Unfortunately, it doesn't work as expected. As <a href="https://github.com/django/daphne/issues/182#issuecomment-387507887">mentioned here</a>, we can use systemd templates and spawn multiple daphne process.</p>
<p>An alternate way is to use <a href="https://pypi.org/project/uvicorn/">uvicorn</a> to start multiple workers. Install uvicorn using pip</p>
<pre class="code literal-block"><span></span>$ pip install uvicorn
</pre>


<p>Start uvicorn ASGI server with</p>
<pre class="code literal-block"><span></span>$ uvicorn avilpage.asgi --log-level critical --workers <span class="m">4</span>
</pre>


<p>This will spin up 4 workers which should be able to handle more load. If this performance is not sufficient, we have to setup a load balancer and spin up multiple servers(just like scaling any other web application).</p>
</div>
        </div>
        <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/devops.html" rel="tag">devops</a></li>
            <li><a class="tag p-category" href="../../tags/django.html" rel="tag">django</a></li>
            <li><a class="tag p-category" href="../../tags/featured.html" rel="tag">featured</a></li>
            <li><a class="tag p-category" href="../../tags/python.html" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../04/reliable-way-to-test-external-apis-without-mocking.html" rel="prev" title="Reliable Way To Test External APIs Without Mocking">Previous post</a>
            </li>
            <li class="next">
                <a href="django-tips-tricks-log-sql-queries-to-console.html" rel="next" title="Django Tips &amp; Tricks #10 - Log SQL Queries To Console">Next post</a>
            </li>
        </ul></nav></aside><div class="full-article-footer">
            <div class="article-footer">

                <div class="avatar-module">
                    <img class="avatar" height="100px" src="../../images/chillaranand.jpg">
</div>

                <p class="avatar-module">
                    Written by
                    <br><b>Chillar Anand</b>
                    <br>
                    Musings about programming, careers &amp; life.
                </p>

            </div>
        </div>

        <hr></article>
</div>
        <!--End of body content-->
        <div id="coral_thread"></div>

        <footer id="footer">
            Contents © 2021         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

            <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script src="../../assets/js/moment-with-locales.min.js"></script><script src="../../assets/js/fancydates.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
        }});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-81644162-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-81644162-1');

    $(document.links).filter(function() {
        return this.hostname != window.location.hostname;
    }).attr('target', '_blank');
    </script><!-- <script>
         (function() {
         var d = document, s = d.createElement('script');
         var url = 'avilpage-coral.herokuapp.com';
         /*         var url = 'http://comments.avilpage.com'; */
         s.src = '//' + url + '/assets/js/embed.js';
         s.async = false;
         s.defer = true;
         s.onload = function() {
         Coral.createStreamEmbed({
         id: "coral_thread",
         autoRender: true,
         rootURL: '//' + url,
         });
         };
         (d.head || d.body).appendChild(s);
         })();
         </script> -->
</body>
</html>
