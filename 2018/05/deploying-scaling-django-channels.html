<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How To Deploy Django Channels To Production | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://avilpage.com/2018/05/deploying-scaling-django-channels.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../04/reliable-way-to-test-external-apis-without-mocking.html" title="Reliable Way To Test External APIs Without Mocking" type="text/html">
<link rel="next" href="django-tips-tricks-log-sql-queries-to-console.html" title="Django Tips &amp; Tricks #10 - Log SQL Queries To Console" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="How To Deploy Django Channels To Production">
<meta property="og:url" content="https://avilpage.com/2018/05/deploying-scaling-django-channels.html">
<meta property="og:description" content="In this article, we will see how to deploy django channels to production and how we can scale it to handle more load. We will be using nginx as proxy server, daphne as ASGI server, gunicorn as WSGI se">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-05-18T21:21:21+05:30">
<meta property="article:tag" content="devops">
<meta property="article:tag" content="django">
<meta property="article:tag" content="featured">
<meta property="article:tag" content="python">
<style>
    .full-article-footer {
    border-top: 1px solid #E0DFDB;
}


.article-footer {
    padding: 20px 10px 10px 10px;
    min-height: 115px;
    display:table;
}


.avatar-module {
    display: table-cell;
    vertical-align: middle;
}


.avatar-module img {
    border-radius: 50%!important;
    height: 120px;
    width: 120px;
    float: left;
    margin:0px 20px 0px 20px;
}


.article-footer p {
    line-height:1.5em;
    padding-left:15px;
}


@media (max-width:750px) {
    .article-footer {
        display:inherit;
        margin:0px;
    }

    .avatar-module {
        display:inherit;
        vertical-align: none;
    }

    .avatar-module img {
        margin-left: auto;
        margin-right: auto;
        display: block;
        float:none;
        margin-top:0px;
    }

    .article-footer p {
        text-align:center;
        padding-left:0px;
    }
}

    </style>
<style>

 h1 {
     font-weight: bold;
     font-size: 25px;
 }

</style>
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

    <!-- Menubar -->
    <nav class="navbar navbar-expand-md static-top mb-4
                navbar-dark
                bg-dark
                "><div class="container">
<!-- This keeps the margins nice -->
            <a class="navbar-brand" href="../../">

                    <span id="blog-title">Avil Page</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="bs-navbar">
                <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../top-10.html" class="nav-link">Top 10</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Tech</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                    
                </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
        </div>
<!-- /.container -->
    </nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="row justify-content-md-center">
        <div class="body-content col col-lg-6">
            <!--Body content-->
            
    <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">How To Deploy Django Channels To Production</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card">
                <span class="byline-name fn p-name" itemprop="author">
                    Chillar Anand
                </span>
            </p>

            <p class="dateline">
                    15 min read
            </p>

            <p class="dateline">
                <a href="#" rel="bookmark">
                    <time class="published dt-published" datetime="2018-05-18T21:21:21+05:30" itemprop="datePublished" title="2018-05-18">2018-05-18</time></a>
            </p>
            
        </div>

        
    </header><div class="e-content entry-content" itemprop="articleBody text">
            <p>In this article, we will see how to deploy <a href="https://pypi.org/project/channels/">django channels</a> to production and how we can scale it to handle more load. We will be using nginx as proxy server, <a href="https://pypi.org/project/daphne/">daphne</a> as ASGI server, gunicorn as WSGI server and redis for channel back-end.</p>
<p>Daphne can serve HTTP requests as well as WebSocket requests. For stability and performance, we will use uwsgi/gunicorn to serve HTTP requests and daphne to serve websocket requests.</p>
<p>We will be using systemd to create and manage processes instead of depending on third party process managers like supervisor or circus. We will be using ansible for managing deployments. If you don't want to use ansible, you can just replace template variables in the following files with actual values.</p>
<h4>Nginx Setup</h4>
<p>Nginx will be routing requests to WSGI server and ASGI server based on URL. Here is nginx configuration for server.</p>
<div class="code"><pre class="code literal-block"><span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">listen</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="n">server_name</span><span class="w"> </span><span class="p">}}:</span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="n">server_name</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="p">{{</span><span class="w"> </span><span class="n">server_name</span><span class="w"> </span><span class="p">}};</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">avilpage</span><span class="o">.</span><span class="n">com</span><span class="o">$</span><span class="n">request_uri</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">listen</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="n">server_name</span><span class="w"> </span><span class="p">}}:</span><span class="mi">443</span><span class="w"> </span><span class="n">ssl</span><span class="p">;</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="n">server_name</span><span class="w"> </span><span class="p">}}</span><span class="w"> </span><span class="n">www</span><span class="o">.</span><span class="p">{{</span><span class="w"> </span><span class="n">server_name</span><span class="w"> </span><span class="p">}};</span>

<span class="w">    </span><span class="n">ssl_certificate</span><span class="w">     </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">avilpage</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">crt</span><span class="p">;</span>
<span class="w">    </span><span class="n">ssl_certificate_key</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">avilpage</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">key</span><span class="p">;</span>

<span class="w">    </span><span class="n">access_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">avilpage</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
<span class="w">    </span><span class="n">error_log</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">avilpage</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8000</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span><span class="w"> </span><span class="o">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="o">$</span><span class="n">http_host</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span><span class="w"> </span><span class="o">$</span><span class="n">remote_addr</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_redirect</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">ws</span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_http_version</span><span class="w"> </span><span class="mf">1.1</span><span class="p">;</span>

<span class="w">            </span><span class="n">proxy_read_timeout</span><span class="w"> </span><span class="mi">86400</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_redirect</span><span class="w">     </span><span class="n">off</span><span class="p">;</span>

<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">Upgrade</span><span class="w"> </span><span class="o">$</span><span class="n">http_upgrade</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="s2">"upgrade"</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="o">$</span><span class="n">host</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span><span class="w"> </span><span class="o">$</span><span class="n">remote_addr</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span><span class="w"> </span><span class="o">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="w">            </span><span class="n">proxy_set_header</span><span class="w"> </span><span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Host</span><span class="w"> </span><span class="o">$</span><span class="n">server_name</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="k">static</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">alias</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="n">project_root</span><span class="w"> </span><span class="p">}}</span><span class="o">/</span><span class="k">static</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w">  </span><span class="o">/</span><span class="n">favicon</span><span class="o">.</span><span class="n">ico</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">alias</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="n">project_root</span><span class="w"> </span><span class="p">}}</span><span class="o">//</span><span class="k">static</span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="n">favicon</span><span class="o">.</span><span class="n">ico</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">location</span><span class="w">  </span><span class="o">/</span><span class="n">robots</span><span class="o">.</span><span class="n">txt</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">alias</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="n">project_root</span><span class="w"> </span><span class="p">}}</span><span class="o">/</span><span class="k">static</span><span class="o">/</span><span class="n">txt</span><span class="o">/</span><span class="n">robots</span><span class="o">.</span><span class="n">txt</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>

<h4>WSGI Server Setup</h4>
<p>We will use gunicorn for wsgi server. We can run gunicorn with</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>gunicorn<span class="w"> </span>avilpage.wsgi<span class="w"> </span>--bind<span class="w"> </span><span class="m">0</span>.0.0.0:8000<span class="w"> </span>--log-level<span class="w"> </span>error<span class="w"> </span>--log-file<span class="o">=</span>-<span class="w"> </span>--settings<span class="w"> </span>avilpage.production_settings
</pre></div>

<p>We can create a systemd unit file to make it as a service.</p>
<div class="code"><pre class="code literal-block"><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">gunicorn</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>


<span class="k">[Service]</span>
<span class="na">PIDFile</span><span class="o">=</span><span class="s">/run/gunicorn/pid</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">Group</span><span class="o">=</span><span class="s">root</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">{{ project_root }}</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">"DJANGO_SETTINGS_MODULE={{ project_name }}.production_settings"</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">{{ venv_bin }}/gunicorn {{ project_name}}.wsgi --bind 0.0.0.0:8000 --log-level error --log-file=- --workers 5 --preload</span>


<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -s HUP $MAINPID</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/kill -s TERM $MAINPID</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-abort</span>
<span class="na">PrivateTmp</span><span class="o">=</span><span class="s">true</span>


<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>

<p>Whenever server restarts, systemd will automatically start gunicorn service. We can also restart gunicorn manually with</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>sudo<span class="w"> </span>service<span class="w"> </span>gunicorn<span class="w"> </span>restart
</pre></div>

<h4>ASGI Server Setup</h4>
<p>We will use daphne for ASGI server and it can be started with</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>daphne<span class="w"> </span>avilpage.asgi:application<span class="w"> </span>--bind<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>--port<span class="w"> </span><span class="m">9000</span><span class="w"> </span>--verbosity<span class="w"> </span><span class="m">1</span>
</pre></div>

<p>We can create a systemd unit file like the previous one to create a service.</p>
<div class="code"><pre class="code literal-block"><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">daphne daemon</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>


<span class="k">[Service]</span>
<span class="na">PIDFile</span><span class="o">=</span><span class="s">/run/daphne/pid</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">Group</span><span class="o">=</span><span class="s">root</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">{{ project_root }}</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">"DJANGO_SETTINGS_MODULE={{ project_name }}.production_settings"</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">{{ venv_bin }}/daphne --bind 0.0.0.0 --port 9000 --verbosity 0 {{project_name}}.asgi:application</span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -s HUP $MAINPID</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/kill -s TERM $MAINPID</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-abort</span>
<span class="na">PrivateTmp</span><span class="o">=</span><span class="s">true</span>


<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>

<h4>Deployment</h4>
<p>Here is <a href="https://github.com/ChillarAnand/eddie/blob/master/ubuntu/config/playbooks/django_setup.yml">an ansible playbook</a> which is used to deploy these config files to our server. To run the playbook on server <code>avilpage.com</code>, execute</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>avilpage.com,<span class="w"> </span>django_setup.yml
</pre></div>

<h4>Scaling</h4>
<p>Now that we have deployed channels to production, we can do performance test to see how our server performs under load.</p>
<p>For WebSockets, we can use <a href="https://www.npmjs.com/package/thor">Thor</a> to run performance test.</p>
<div class="code"><pre class="code literal-block">thor<span class="w"> </span>-C<span class="w"> </span><span class="m">100</span><span class="w"> </span>-A<span class="w"> </span><span class="m">1000</span><span class="w"> </span>wss://avilpage.com/ws/books/
</pre></div>

<p>Our server is able to handle <code>100 requests per second</code> with a <code>latency of 800ms</code>. This is good enough for low traffic website.</p>
<p>To improve performance, we can use unix sockets instead of rip/port for gunicorn and daphne. Also, daphne has support for multiprocessing using <a href="#">shared file descriptors</a>. Unfortunately, it doesn't work as expected. As <a href="https://github.com/django/daphne/issues/182#issuecomment-387507887">mentioned here</a>, we can use systemd templates and spawn multiple daphne process.</p>
<p>An alternate way is to use <a href="https://pypi.org/project/uvicorn/">uvicorn</a> to start multiple workers. Install uvicorn using pip</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>uvicorn
</pre></div>

<p>Start uvicorn ASGI server with</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>uvicorn<span class="w"> </span>avilpage.asgi<span class="w"> </span>--log-level<span class="w"> </span>critical<span class="w"> </span>--workers<span class="w"> </span><span class="m">4</span>
</pre></div>

<p>This will spin up 4 workers which should be able to handle more load. If this performance is not sufficient, we have to setup a load balancer and spin up multiple servers(just like scaling any other web application).</p>
        </div>
        <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/devops.html" rel="tag">devops</a></li>
            <li><a class="tag p-category" href="../../tags/django.html" rel="tag">django</a></li>
            <li><a class="tag p-category" href="../../tags/featured.html" rel="tag">featured</a></li>
            <li><a class="tag p-category" href="../../tags/python.html" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../04/reliable-way-to-test-external-apis-without-mocking.html" rel="prev" title="Reliable Way To Test External APIs Without Mocking">Previous post</a>
            </li>
            <li class="next">
                <a href="django-tips-tricks-log-sql-queries-to-console.html" rel="next" title="Django Tips &amp; Tricks #10 - Log SQL Queries To Console">Next post</a>
            </li>
        </ul></nav></aside><div class="full-article-footer">
            <div class="article-footer">

                <div class="avatar-module">
                    <img class="avatar" height="100px" src="../../images/chillaranand.jpg">
</div>

                <p class="avatar-module">
                    <b>Chillar Anand</b>
                    <br>
                    A blog about python, careers &amp; life.
                    <br>
                    To contact me, <a href="https://forms.gle/Hre4z4aLqJA5zYWe6">send a message here</a>.
                </p>

            </div>
        </div>

        
    </article><!--End of body content--><footer id="footer"><div class="container align-items-center justify-content-center d-flex">

<footer class="footer"><a href="https://github.com/ChillarAnand">
<img src="../../images/icons8-github.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://stackoverflow.com/users/2698552/chillar-anand">
<img src="../../images/icons8-so.svg" alt="github-chillar-anand" height="30"></a>

  

<a href="https://youtube.com/@avilpage">
<img src="../../images/icons8-youtube.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://linkedin.com/in/chillaranand">
<img src="../../images/icons8-linkedin.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://twitter.com/chillaranand">
<img src="../../images/icons8-twitter.svg" alt="github-chillar-anand" height="34"></a>

</footer>
</div>

<br><br></footer>
</div>
    </div>
    </div>

                <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
