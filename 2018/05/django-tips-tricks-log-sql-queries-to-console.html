<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="author" content="Chillar Anand">
<title>Django Tips &amp; Tricks #10 - Log SQL Queries To Console | Avil Page</title>
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/style.css" rel="stylesheet" type="text/css">
<link rel="canonical" href="http://avilpage.com/2018/05/django-tips-tricks-log-sql-queries-to-console.html">
<!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<style>
     #wrapper {
         width: 100%;
         margin: 0;
     }

     #first-div {
         width: 16%;
         height: 90px;
         /*          margin: 10px 0px 0px 10px; */
         margin: 0;
         float: left ;
     }

     #second-div {
         width: 84%;
         height: 72px;
         margin: 18px 0px 0px 0px;
         float: left ;
     }
    </style>
</head>
<body>
        <div id="">
            <div id="container">
                <!-- <h1 id="blog-title">
                     <a href="http://avilpage.com/" title="Avil Page" rel="home">Avil Page</a>
                     </h1> -->




    <div class="postbox">

        <article class="postbox post-text"><div class="h-entry" itemscope="itemscope" itemtype="http://schema.org/Article">
                    <h1 class="p-name" itemprop="headline name">Django Tips &amp; Tricks #10 - Log SQL Queries To Console</h1>




                5 min read


                <hr>
<div class="e-content" itemprop="articleBody text">
                    <div>
<p>Django ORM makes easy to interact with database. To understand what is happening behing the scenes or to see SQL performance, we can log all the SQL queries that be being executed. In this article, we will see various ways to achieve this.</p>
<h4>Using debug-toolbar</h4>
<p><a href="https://pypi.org/project/django-debug-toolbar/" target="_blank">Django debug toolbar</a> provides panels to show debug information about requests. It has SQL panel which shows all executed SQL queries and time taken for them.</p>
<p align="center">
<img src="../../images/django-sql-log-toolbar.png" height="300px" width="600"></p>

<p>When building REST APIs or micro services where django templating engine is not used, <a href="https://github.com/jazzband/django-debug-toolbar/issues/1059" target="_blank">this method won't work</a>. In these situations, we have to log SQL queries to console.</p>
<h4>Using django-extensions</h4>
<p><a href="https://pypi.org/project/django-extensions/">Django-extensions</a> provides lot of utilities for productive development. For <code>runserver_plus</code> and <code>shell_plus</code> commands, it accepts and optional <code>--print-sql</code> argument, which prints all the SQL queries that are being executed.</p>
<pre class="code literal-block"><span></span>./manage.py runserver_plus --print-sql
./manage.py shell_plus --print-sql
</pre>


<p>Whenever an SQL query gets executed, it prints the query and time taken for it in console.</p>
<pre class="code literal-block"><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_staff</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="n">SELECT</span> <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"id"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"password"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"last_login"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"is_superuser"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"username"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"first_name"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"last_name"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"email"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"is_staff"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"is_active"</span><span class="p">,</span>
       <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"date_joined"</span>
  <span class="n">FROM</span> <span class="s2">"auth_user"</span>
 <span class="n">WHERE</span> <span class="s2">"auth_user"</span><span class="o">.</span><span class="s2">"is_staff"</span> <span class="o">=</span> <span class="n">true</span>
 <span class="n">LIMIT</span> <span class="mi">21</span>


<span class="n">Execution</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.002107</span><span class="n">s</span> <span class="p">[</span><span class="n">Database</span><span class="p">:</span> <span class="n">default</span><span class="p">]</span>

<span class="o">&lt;</span><span class="n">QuerySet</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">anand</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">chillar</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
</pre>


<h4>Using django-querycount</h4>
<p><a href="https://pypi.org/project/django-querycount/">Django-querycount</a> provides a middleware to show SQL query count and show duplicate queries on console.</p>
<pre class="code literal-block"><span></span><span class="p">|</span>------<span class="p">|</span>-----------<span class="p">|</span>----------<span class="p">|</span>----------<span class="p">|</span>----------<span class="p">|</span>------------<span class="p">|</span>
<span class="p">|</span> Type <span class="p">|</span> Database  <span class="p">|</span>   Reads  <span class="p">|</span>  Writes  <span class="p">|</span>  Totals  <span class="p">|</span> Duplicates <span class="p">|</span>
<span class="p">|</span>------<span class="p">|</span>-----------<span class="p">|</span>----------<span class="p">|</span>----------<span class="p">|</span>----------<span class="p">|</span>------------<span class="p">|</span>
<span class="p">|</span> RESP <span class="p">|</span>  default  <span class="p">|</span>    <span class="m">3</span>     <span class="p">|</span>    <span class="m">0</span>     <span class="p">|</span>    <span class="m">3</span>     <span class="p">|</span>     <span class="m">1</span>      <span class="p">|</span>
<span class="p">|</span>------<span class="p">|</span>-----------<span class="p">|</span>----------<span class="p">|</span>----------<span class="p">|</span>----------<span class="p">|</span>------------<span class="p">|</span>
Total queries: <span class="m">3</span> in <span class="m">1</span>.7738s


Repeated <span class="m">1</span> times.
SELECT <span class="s2">"django_session"</span>.<span class="s2">"session_key"</span>,
<span class="s2">"django_session"</span>.<span class="s2">"session_data"</span>, <span class="s2">"django_session"</span>.<span class="s2">"expire_date"</span> FROM
<span class="s2">"django_session"</span> WHERE <span class="o">(</span><span class="s2">"django_session"</span>.<span class="s2">"session_key"</span> <span class="o">=</span>
<span class="s1">'dummy_key AND "django_session"."expire_date"</span>
<span class="s1">&gt; '</span><span class="m">2018</span>-05-31T09:38:56.369469+00:00<span class="err">'</span>::timestamptz<span class="o">)</span>
</pre>


<p>This package provides <a href="https://github.com/bradmontgomery/django-querycount#settings">additional settings</a> to customize output.</p>
<h4>Django logging</h4>
<p>Instead of using any 3rd party package, we can use <code>django.db.backends</code> logger to print all the SQL queries.</p>
<p>Add <code>django.db.backends</code> to loggers list and set log level and handlers.</p>
<pre class="code literal-block"><span></span>    <span class="s1">'loggers'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'django.db.backends'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'level'</span><span class="p">:</span> <span class="s1">'DEBUG'</span><span class="p">,</span>
            <span class="s1">'handlers'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'console'</span><span class="p">,</span> <span class="p">],</span>
        <span class="p">},</span>
</pre>


<p>In runserver console, we can see all SQL queries that are being executed.</p>
<pre class="code literal-block"><span></span>(0.001) SELECT "django_admin_log"."id", "django_admin_log"."action_time", "django_admin_log"."user_id", "django_admin_log"."content_type_id", "django_admin_log"."object_id", "django_admin_log"."object_repr", "django_admin_log"."action_flag", "django_admin_log"."change_message", "auth_user"."id", "auth_user"."password", "auth_user"."last_login", "auth_user"."is_superuser", "auth_user"."username", "auth_user"."first_name", "auth_user"."last_name", "auth_user"."email", "auth_user"."is_staff", "auth_user"."is_active", "auth_user"."date_joined", "django_content_type"."id", "django_content_type"."app_label", "django_content_type"."model" FROM "django_admin_log" INNER JOIN "auth_user" ON ("django_admin_log"."user_id" = "auth_user"."id") LEFT OUTER JOIN "django_content_type" ON ("django_admin_log"."content_type_id" = "django_content_type"."id") WHERE "django_admin_log"."user_id" = 4 ORDER BY "django_admin_log"."action_time" DESC LIMIT 10; args=(4,)
[2018/06/03 15:06:59] HTTP GET /admin/ 200 [1.69, 127.0.0.1:47734]
</pre>


<p>These are few ways to log all SQL queries to console. We can also write a custom middleware for better logging of these queries and get some insights.</p>
</div>
                </div>
            </div>

                <b> Tags: </b>
                    <a href="../../tags/django.html">django</a>
                        |
                    <a href="../../tags/django-tips-tricks.html">django-tips-tricks</a>
                        |
                    <a href="../../tags/python.html">python</a>

            <br><hr>
<div id="wrapper">
                <div id="first-div">
                    <img src="https://s.gravatar.com/avatar/608fa09693cef8d410834bd55755dbed?s=80">
</div>
                <div id="second-div">
                    I am Chillar Anand. I daydream a lot and write about the things that interest me here.
                    You can read more about <a href="../../p/about-avilpage.html">this blog here</a>.
                </div>
            </div>

            <hr>
<a href="../../">
                <h2>See all articles</h2>
            </a>

            <a href="../../rss.xml">
                <h3>RSS Feed for the blog</h3>
            </a>

            <a href="https://github.com/ChillarAnand/avilpage.com">
                Edit this page
            </a>

            <hr>
<section class="comments hidden-print"><h2>Comments</h2>
                                    <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="avilpage",
            disqus_url="http://avilpage.com/2018/05/django-tips-tricks-log-sql-queries-to-console.html",
        disqus_title="Django Tips & Tricks #10 - Log SQL Queries To Console",
        disqus_identifier="cache/posts/2018/05/django-tips-tricks-log-sql-queries-to-console.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


                </section></article>
</div>
                   <script>var disqus_shortname="avilpage";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><br>
</div>


            <!--Sidebar content-->
            <!-- <ul class="unstyled">
                     

                                 <li><a href="/">Articles</a>
                <li><a href="/about">About.html</a>
                <li><a href="/rss.xml">RSS</a>

                 </ul> -->
            <br>
</div>
    </body>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                             m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-81644162-1', 'auto');
    ga('send', 'pageview');

    </script>
</html>
