<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Autoscale k8s pods with queue size (KEDA) | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://avilpage.com/2025/03/autoscale-k8s-pods-with-queue-size-keda.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../02/free-dockerhub-alternative-ecr-gallery.html" title="Free DockerHub Alternative - ECR Public Gallery" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Autoscale k8s pods with queue size (KEDA)">
<meta property="og:url" content="https://avilpage.com/2025/03/autoscale-k8s-pods-with-queue-size-keda.html">
<meta property="og:description" content="Introduction
Kubernetes(k8s) is a popular container orchestration tool, and it provides Horizontal Pod Autoscaler(HPA) to scale pods based on CPU and Memory usage. 
To scale pods based on the queue si">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-03-27T11:37:52+05:30">
<meta property="article:tag" content="kubernetes">
<style>
    .full-article-footer {
    border-top: 1px solid #E0DFDB;
}


.article-footer {
    padding: 20px 10px 10px 10px;
    min-height: 115px;
    display:table;
}


.avatar-module {
    display: table-cell;
    vertical-align: middle;
}


.avatar-module img {
    border-radius: 50%!important;
    height: 120px;
    width: 120px;
    float: left;
    margin:0px 20px 0px 20px;
}


.article-footer p {
    line-height:1.5em;
    padding-left:15px;
}


@media (max-width:750px) {
    .article-footer {
        display:inherit;
        margin:0px;
    }

    .avatar-module {
        display:inherit;
        vertical-align: none;
    }

    .avatar-module img {
        margin-left: auto;
        margin-right: auto;
        display: block;
        float:none;
        margin-top:0px;
    }

    .article-footer p {
        text-align:center;
        padding-left:0px;
    }
}

    </style>
<style>

 h1 {
     font-weight: bold;
     font-size: 25px;
 }

</style>
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

    <!-- Menubar -->
    <nav class="navbar navbar-expand-md static-top mb-4
                navbar-dark
                bg-dark
                "><div class="container">
<!-- This keeps the margins nice -->
            <a class="navbar-brand" href="../../">

                    <span id="blog-title">Avil Page</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="bs-navbar">
                <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../guides.html" class="nav-link">Guides</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Blog</a>
                </li>
<li class="nav-item">
<a href="../../books.html" class="nav-link">Books</a>
                </li>
<li class="nav-item">
<a href="../../talks.html" class="nav-link">Talks</a>
                </li>
<li class="nav-item">
<a href="../../projects.html" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                    
                </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
        </div>
<!-- /.container -->
    </nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="row justify-content-md-center">
        <div class="body-content col col-lg-6">
            <!--Body content-->
            
    <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Autoscale k8s pods with queue size (KEDA)</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card">
                <span class="byline-name fn p-name" itemprop="author">
                    Chillar Anand
                </span>
            </p>

            <p class="dateline">
                    14 min read
            </p>

            <p class="dateline">
                <a href="#" rel="bookmark">
                    <time class="published dt-published" datetime="2025-03-27T11:37:52+05:30" itemprop="datePublished" title="2025-03-27">2025-03-27</time></a>
            </p>
            
        </div>

        
    </header><div class="e-content entry-content" itemprop="articleBody text">
            <p><img alt="keda-postgreql-scaling" src="../../images/keda-postgresql-scaling1.png"></p>
<h4>Introduction</h4>
<p>Kubernetes(k8s) is a popular container orchestration tool, and it provides Horizontal Pod Autoscaler(HPA) to scale pods based on CPU and Memory usage. </p>
<p>To scale pods based on the queue size we can use <a href="https://keda.sh/">KEDA</a>.</p>
<h4>Setup</h4>
<p>For this demo, we will use PostgreSQL table to store tasks and KEDA to scale the pods based on the queue size.</p>
<p>As written earlier, we can use k3d and <a href="#">setup k8s cluster with a single command</a> anywhere.</p>
<p>Once the cluster is up, we can set up a simple shell script to produce and consume tasks from the PostgreSQL table.</p>
<p>I am adding only relevant snippets here. You can find the complete code in the <a href="https://github.com/AvilPage/keda-postgresql-demo">GitHub repo</a>.</p>
<p>PostgreSQL deployment:</p>
<div class="code"><pre class="code literal-block"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13</span>
</pre></div>

<p>Producer shell script:</p>
<div class="code"><pre class="code literal-block"><span class="ch">#!/bin/bash</span>

psql<span class="w"> </span>-h<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_HOST</span><span class="s2">"</span><span class="w"> </span>-U<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_USER</span><span class="s2">"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_NAME</span><span class="s2">"</span><span class="w"> </span><span class="s">&lt;&lt;-EOSQL</span>
<span class="s">  CREATE TABLE IF NOT EXISTS tasks (</span>
<span class="s">      id SERIAL PRIMARY KEY,</span>
<span class="s">      description TEXT NOT NULL,</span>
<span class="s">      status TEXT NOT NULL</span>
<span class="s">  );</span>
<span class="s">EOSQL</span>

<span class="c1"># Continuously insert tasks</span>
<span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>psql<span class="w"> </span>-h<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_HOST</span><span class="s2">"</span><span class="w"> </span>-U<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_USER</span><span class="s2">"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_NAME</span><span class="s2">"</span><span class="w"> </span><span class="s">&lt;&lt;-EOSQL</span>
<span class="s">    INSE</span>RT<span class="w"> </span>INTO<span class="w"> </span>tasks<span class="w"> </span><span class="o">(</span>description,<span class="w"> </span>status<span class="o">)</span>
<span class="w">    </span>VALUES<span class="w"> </span><span class="o">(</span><span class="s1">'$DESCRIPTION'</span>,<span class="w"> </span><span class="s1">'$STATUS'</span><span class="o">)</span><span class="p">;</span>
<span class="k">done</span>
</pre></div>

<p>Producer dockerfile:</p>
<div class="code"><pre class="code literal-block"><span class="k">FROM</span><span class="w"> </span><span class="s">postgres:13</span>

<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>bash<span class="w"> </span>curl

<span class="k">COPY</span><span class="w"> </span>producer.sh<span class="w"> </span>/producer.sh

<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/producer.sh

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">"/producer.sh"</span><span class="p">]</span>
</pre></div>

<p>Producer deployment:</p>
<div class="code"><pre class="code literal-block"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">task-producer</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">task-producer</span>
<span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
</pre></div>

<p>Consumer shell script:</p>
<div class="code"><pre class="code literal-block"><span class="ch">#!/bin/bash</span>

<span class="nv">TASK</span><span class="o">=</span><span class="k">$(</span>psql<span class="w"> </span>-h<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_HOST</span><span class="s2">"</span><span class="w"> </span>-U<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_USER</span><span class="s2">"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_NAME</span><span class="s2">"</span><span class="w"> </span>-t<span class="w"> </span><span class="s">&lt;&lt;-EOSQL</span>
<span class="s">  SELECT id, description, status FROM tasks</span>
<span class="s">  WHERE status != 'Completed'</span>
<span class="s">  ORDER BY id</span>
<span class="s">  LIMIT 1;</span>
<span class="s">EOSQL</span>

<span class="nv">TASK_ID</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">"</span><span class="nv">$TASK</span><span class="s2">"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">'{print $1}'</span><span class="k">)</span>

psql<span class="w"> </span>-h<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_HOST</span><span class="s2">"</span><span class="w"> </span>-U<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_USER</span><span class="s2">"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_NAME</span><span class="s2">"</span><span class="w"> </span><span class="s">&lt;&lt;-EOSQL</span>
<span class="s">  UPDATE tasks</span>
<span class="s">  SET status = 'Completed'</span>
<span class="s">  WHERE id = $TASK_ID;</span>
<span class="s">EOSQL</span>
</pre></div>

<p>Consumer dockerfile:</p>
<div class="code"><pre class="code literal-block"><span class="k">FROM</span><span class="w"> </span><span class="s">postgres:13</span>

<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>bash

<span class="k">COPY</span><span class="w"> </span>consumer.sh<span class="w"> </span>/consumer.sh

<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/consumer.sh

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">"/consumer.sh"</span><span class="p">]</span>
</pre></div>

<p>Consumer deployment:</p>
<div class="code"><pre class="code literal-block"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">task-consumer</span>
<span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">task-consumer</span>
<span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
</pre></div>

<p>Instead of pushing these images to any container registry, we can directly load the images into cluster using <code>k3d image</code>.</p>
<div class="code"><pre class="code literal-block">k3d<span class="w"> </span>image<span class="w"> </span>import<span class="w"> </span>task-producer<span class="w"> </span>--cluster<span class="w"> </span>demo-cluster
k3d<span class="w"> </span>image<span class="w"> </span>import<span class="w"> </span>task-consumer<span class="w"> </span>--cluster<span class="w"> </span>demo-cluster
</pre></div>

<p>After that, we can deploy postgres, consumer and producer using the above deployment files.</p>
<p>Once the deployment is done, we can monitor the tasks from pod logs.</p>
<p>Lets install KEDA in the cluster and setup a scaled-object to scale the consumer pods based on number of pending tasks.</p>
<div class="code"><pre class="code literal-block">helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>kedacore<span class="w"> </span>https://kedacore.github.io/charts
helm<span class="w"> </span>repo<span class="w"> </span>update
helm<span class="w"> </span>install<span class="w"> </span>keda<span class="w"> </span>kedacore/keda<span class="w"> </span>
</pre></div>

<p>ScaledObject:</p>
<div class="code"><pre class="code literal-block"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keda.sh/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ScaledObject</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">task-consumer-scaler</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">task-consumer</span><span class="w">  </span>
<span class="w">  </span><span class="nt">pollingInterval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w">    </span>
<span class="w">  </span><span class="nt">cooldownPeriod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w">     </span>
<span class="w">  </span><span class="nt">minReplicaCount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w">    </span>
<span class="w">  </span><span class="nt">maxReplicaCount</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w">   </span>
<span class="w">  </span><span class="nt">triggers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql</span>
<span class="w">      </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-service</span><span class="w">  </span>
<span class="w">        </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">"SELECT</span><span class="nv"> </span><span class="s">COUNT(*)</span><span class="nv"> </span><span class="s">FROM</span><span class="nv"> </span><span class="s">tasks</span><span class="nv"> </span><span class="s">WHERE</span><span class="nv"> </span><span class="s">status</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">'Completed';"</span>
<span class="w">        </span><span class="nt">targetQueryValue</span><span class="p">:</span><span class="w"> </span><span class="s">"10"</span><span class="w"> </span>
</pre></div>

<p>With this, KEDA will scale the consumer pods based on the number of tasks in the PostgreSQL table. The <code>targetQueryValue</code> is set to 10, which means if there are more than 10 tasks in the table, KEDA will scale up the consumer pods.</p>
<p>In the cluster, after a while, a bunch of tasks will be created in the PostgreSQL table. Now, we can set the status of all tasks to empty so that we can see auto-scaling in action.</p>
<div class="code"><pre class="code literal-block">kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>task-producer-&lt;pod-id&gt;<span class="w"> </span>--<span class="w"> </span>psql<span class="w"> </span>-h<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_HOST</span><span class="s2">"</span><span class="w"> </span>-U<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_USER</span><span class="s2">"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"</span><span class="nv">$DB_NAME</span><span class="s2">"</span><span class="w"> </span><span class="s">&lt;&lt;-EOSQL</span>
<span class="s">  UPDATE tasks</span>
<span class="s">  SET status = '';</span>
<span class="s">EOSQL</span>
</pre></div>

<p>On k8s dashboard, we can see the consumer pods scaling up and down based on the number of tasks in the PostgreSQL table.</p>
<p><img alt="keda-postgreql-scaling" src="../../images/keda-postgresql-scaling.png"></p>
<h4>Conclusion</h4>
<p>KEDA is a powerful tool to scale k8s pods based on custom metrics. In this post, we have used PostgreSQL but we can use KEDA with variety of other data stores as well. Full code for this post is <a href="https://github.com/AvilPage/keda-postgresql-demo">available here</a>.</p>
        </div>

            <hr>
            Need further help with this? <a href="https://forms.gle/Hre4z4aLqJA5zYWe6">Feel free to send a message</a>.
            <hr>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/kubernetes.html" rel="tag">kubernetes</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../02/free-dockerhub-alternative-ecr-gallery.html" rel="prev" title="Free DockerHub Alternative - ECR Public Gallery">Previous post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer"><div class="full-article-footer">
    <div class="article-footer">

        <div class="avatar-module">
            <img class="avatar" height="100px" src="../../images/chillaranand.jpg">
</div>

        <p class="avatar-module">
            <b>Chillar Anand</b>
            <br>
            Improving Health &amp; Wealth with Technology
            <br></p>

    </div>
</div>

<div class="container align-items-center justify-content-center d-flex">

<footer class="footer"><a href="https://github.com/ChillarAnand">
<img src="../../images/icons8-github.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://stackoverflow.com/users/2698552/chillar-anand">
<img src="../../images/icons8-so.svg" alt="github-chillar-anand" height="30"></a>

  

<a href="https://youtube.com/@avilpage">
<img src="../../images/icons8-youtube.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://linkedin.com/in/chillaranand">
<img src="../../images/icons8-linkedin.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://twitter.com/chillaranand">
<img src="../../images/icons8-twitter.svg" alt="github-chillar-anand" height="34"></a>

</footer>
</div>

<br><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8127755709093749" crossorigin="anonymous"></script></footer>
</div>
    </div>
    </div>

                <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
