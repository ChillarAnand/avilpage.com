<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="How to speed up python docker builds and reduce build time.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Make Python Docker Builds Slim &amp; Fast | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://avilpage.com/2020/10/python-docker-build-slim-fast.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="../07/deploy-mirth-to-kubernetes.html" title="How To Deploy Mirth Connect To Kubernetes" type="text/html">
<link rel="next" href="../11/python-web-applications-performance-sentry.html" title="Find Performance Issues In Web Apps with Sentry" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Make Python Docker Builds Slim &amp; Fast">
<meta property="og:url" content="https://avilpage.com/2020/10/python-docker-build-slim-fast.html">
<meta property="og:description" content="How to speed up python docker builds and reduce build time.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-10-31T18:23:13+05:30">
<meta property="article:tag" content="devops">
<meta property="article:tag" content="featured">
<meta property="article:tag" content="python">
<style>

 h1 {
     font-weight: bold;
     font-size: 25px;
 }

</style>
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

    <!-- Menubar -->
    <nav class="navbar navbar-expand-md static-top mb-4
                navbar-dark
                bg-dark
                "><div class="container">
<!-- This keeps the margins nice -->
            <a class="navbar-brand" href="../../">

                    <span id="blog-title">Avil Page</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="bs-navbar">
                <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../top-10.html" class="nav-link">Top 10</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Articles</a>
                </li>
<li class="nav-item">
<a href="../../p/projects.html" class="nav-link">Projects</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                    
                </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
        </div>
<!-- /.container -->
    </nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="row justify-content-md-center">
        <div class="body-content col col-lg-6">
            <!--Body content-->
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Make Python Docker Builds Slim &amp; Fast</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Chillar Anand
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2020-10-31T18:23:13+05:30" itemprop="datePublished" title="2020-10-31">2020-10-31</time></a>
            </p>
                    <p class="sourceline"><a href="python-docker-build-slim-fast.md" class="sourcelink">Source</a></p>

        </div>
        
    </header>


    

        7 min read



    <div class="e-content entry-content" itemprop="articleBody text">
    <h4>Introduction</h4>
<p>When using Docker, if the build is taking time or the build image is huge, it will waste system resources as well as our time. In this article, let's see how to reduce build time as well as image size when using Docker for Python projects.</p>
<h4>Project</h4>
<p>Let us take a hello world application written in flask.</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">flask</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'hello world - v1.0.0'</span>
</pre></div>

<p>Let's create a requirements.txt file to list out python packages required for the project.</p>
<div class="code"><pre class="code literal-block">flask==1.1.2
pandas==1.1.2
</pre></div>

<p>Pandas binary wheel size is ~10MB. It is included in requirements to see how python packages affect docker image size.</p>
<p>Here is our Dockerfile to run the flask application.</p>
<div class="code"><pre class="code literal-block">FROM python:3.7

ADD . /app

WORKDIR /app

RUN python -m pip install -r requirements.txt

EXPOSE 5000

ENTRYPOINT [ "python" ]

CMD [ "-m" "flask" "run" ]
</pre></div>

<p>Let's use the following commands to measure the image size &amp; build time with/without cache.</p>
<div class="code"><pre class="code literal-block">$ docker build . -t flask:0.0 --pull --no-cache
<span class="o">[</span>+<span class="o">]</span> Building <span class="m">45</span>.3s <span class="o">(</span><span class="m">9</span>/9<span class="o">)</span> FINISHED

$ touch app.py  <span class="c1"># modify app.py file</span>

$ docker build . -t flask:0.1
<span class="o">[</span>+<span class="o">]</span> Building <span class="m">15</span>.3s <span class="o">(</span><span class="m">9</span>/9<span class="o">)</span> FINISHED

$ docker images <span class="p">|</span> grep flask
flask               <span class="m">0</span>.1     06d3e985f12e    <span class="m">1</span>.01GB
</pre></div>

<p>With the current docker, here are the results.</p>
<p><img src="../../images/docker0.png" style="vertical-align:middle"></p>
<h4>1. Install requirements first</h4>
<div class="code"><pre class="code literal-block">FROM python:3.7

WORKDIR /app

ADD ./requirements.txt /app/requirements.txt

RUN python -m pip install -r requirements.txt

ADD . /app

EXPOSE 5000

ENTRYPOINT [ "python" ]

CMD [ "-m" "flask" "run" ]
</pre></div>

<p>Let us modify the docker file to install requirements first and then add code to the docker image.</p>
<p><img src="../../images/docker1.png" style="vertical-align:middle"></p>
<p>Now, build without cache took almost the same time. With cache, the build is completed in a second. Since docker caches step by step, it has cached python package installation step and thereby reducing the build time.</p>
<h4>2. Disable Cache</h4>
<div class="code"><pre class="code literal-block">FROM python:3.7

WORKDIR /app

ADD ./requirements.txt /app/requirements.txt

RUN python -m pip install -r requirements.txt --no-cache

ADD . /app

EXPOSE 5000

ENTRYPOINT [ "python" ]

CMD [ "-m" "flask" "run" ]
</pre></div>

<p>By default, pip will cache the downloaded packages. Since we don't need a cache inside docker, let's disable pip cache by passing <code>--no-cache</code> argument.</p>
<p><img src="../../images/docker2.png" style="vertical-align:middle"></p>
<p>This reduced the docker image size by ~20MB. In real-world projects, where there are a good number of dependencies, the overall image size will be reduced a lot.</p>
<h4>3. Use slim variant</h4>
<p>Till now, we have been using defacto Python variant. It has a large number of common debian packages. There is a slim variant that doesn't contain all these common packages<sup id="fnref:dpy"><a class="footnote-ref" href="python-docker-build-slim-fast.html#fn:dpy">4</a></sup>. Since we don't need all these debian packages, let's use slim variant.</p>
<div class="code"><pre class="code literal-block">FROM python:3.7-slim

...
</pre></div>

<p><img src="../../images/docker3.png" style="vertical-align:middle"></p>
<p>This reduced the docker image size by ~750 MB without affecting the build time.</p>
<h4>4. Build from source</h4>
<p>Python packages can be installed via wheels (.whl files) for a faster and smoother installation. We can also install them via source code. If we look at Pandas project files on PyPi<sup id="fnref:pandas"><a class="footnote-ref" href="python-docker-build-slim-fast.html#fn:pandas">1</a></sup>, it provides both wheels as well as tar zip source files. Pip will prefer wheels over source code the installation process will be much smoother.</p>
<p>To reduce Docker image size, we can build from source instead of using the wheel. This will increase build time as the python package will take some time to compile while building.</p>
<div class="code"><pre class="code literal-block">
</pre></div>

<p><img src="../../images/docker4.png" style="vertical-align:middle"></p>
<p>Here build size is reduced by ~20MB but the build has increased to 15 minutes.</p>
<h4>5. Use Alpine</h4>
<p>Earlier we have used, python slim variant the base image. However, there is Alpine variant which is much smaller than slim. One caveat with using alpine is Python wheels won't work with this image<sup id="fnref:aw"><a class="footnote-ref" href="python-docker-build-slim-fast.html#fn:aw">2</a></sup>.</p>
<p>We have to build all packages from source. For example, packages like TensorFlow provide only wheels for installation. To install this on Alpine, we have to install from the source which will take additional effort to figure out dependencies and install.</p>
<p>Using Alpine will reduce the image size by ~70 MB but it is not recomended to use Alpine as wheels won't work with this image.</p>
<p><img src="../../images/docker5.png" style="vertical-align:middle"></p>
<p>All the docker files used in the article are available on github<sup id="fnref:gh"><a class="footnote-ref" href="python-docker-build-slim-fast.html#fn:gh">3</a></sup>.</p>
<h4>Conclusion</h4>
<p>We have started with a docker build of 1.01 GB and reduced it to 0.13 GB. We have also optimized build times using the docker caching mechanism. We can use appropriate steps to optimize build for size or speed or both.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:pandas">
<p><a href="https://pypi.org/project/pandas/#files">https://pypi.org/project/pandas/#files</a> <a class="footnote-backref" href="python-docker-build-slim-fast.html#fnref:pandas" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:aw">
<p><a href="https://github.com/docker-library/docs/issues/904">https://github.com/docker-library/docs/issues/904</a> <a class="footnote-backref" href="python-docker-build-slim-fast.html#fnref:aw" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:gh">
<p><a href="https://github.com/ChillarAnand/library-docker">https://github.com/ChillarAnand/library-docker</a> <a class="footnote-backref" href="python-docker-build-slim-fast.html#fnref:gh" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
<li id="fn:dpy">
<p><a href="https://hub.docker.com/_/python">https://hub.docker.com/_/python</a> <a class="footnote-backref" href="python-docker-build-slim-fast.html#fnref:dpy" title="Jump back to footnote 4 in the text">↩</a></p>
</li>
</ol>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/devops.html" rel="tag">devops</a></li>
            <li><a class="tag p-category" href="../../tags/featured.html" rel="tag">featured</a></li>
            <li><a class="tag p-category" href="../../tags/python.html" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../07/deploy-mirth-to-kubernetes.html" rel="prev" title="How To Deploy Mirth Connect To Kubernetes">Previous post</a>
            </li>
            <li class="next">
                <a href="../11/python-web-applications-performance-sentry.html" rel="next" title="Find Performance Issues In Web Apps with Sentry">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
                Contents © 2022         <a href="mailto:">Chillar Anand</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
                
            </footer>
</div>
    </div>
    </div>

                <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
