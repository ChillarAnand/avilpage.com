<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="How to setup continuous deployment to kubernetes in a continuous integration environment?">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Continuous Deployment To Kubernetes With Skaffold | Avil Page</title>
<link href="../../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://avilpage.com/2020/04/setup-continuous-deployment-with-kubernetes.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Chillar Anand">
<link rel="prev" href="work-from-home-tips.html" title="Work From Home Tips For Non-remote Workers" type="text/html">
<link rel="next" href="../05/tips-on-improving-kubectl-productivity.html" title="Tips On Improving kubectl Productivity" type="text/html">
<meta property="og:site_name" content="Avil Page">
<meta property="og:title" content="Continuous Deployment To Kubernetes With Skaffold">
<meta property="og:url" content="https://avilpage.com/2020/04/setup-continuous-deployment-with-kubernetes.html">
<meta property="og:description" content="How to setup continuous deployment to kubernetes in a continuous integration environment?">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-04-30T16:45:36+05:30">
<meta property="article:tag" content="aws">
<meta property="article:tag" content="devops">
<meta property="article:tag" content="kubernetes">
<style>
    .full-article-footer {
    border-top: 1px solid #E0DFDB;
}


.article-footer {
    padding: 20px 10px 10px 10px;
    min-height: 115px;
    display:table;
}


.avatar-module {
    display: table-cell;
    vertical-align: middle;
}


.avatar-module img {
    border-radius: 50%!important;
    height: 120px;
    width: 120px;
    float: left;
    margin:0px 20px 0px 20px;
}


.article-footer p {
    line-height:1.5em;
    padding-left:15px;
}


@media (max-width:750px) {
    .article-footer {
        display:inherit;
        margin:0px;
    }

    .avatar-module {
        display:inherit;
        vertical-align: none;
    }

    .avatar-module img {
        margin-left: auto;
        margin-right: auto;
        display: block;
        float:none;
        margin-top:0px;
    }

    .article-footer p {
        text-align:center;
        padding-left:0px;
    }
}

    </style>
<style>

 h1 {
     font-weight: bold;
     font-size: 25px;
 }

</style>
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

    <!-- Menubar -->
    <nav class="navbar navbar-expand-md static-top mb-4
                navbar-dark
                bg-dark
                "><div class="container">
<!-- This keeps the margins nice -->
            <a class="navbar-brand" href="../../">

                    <span id="blog-title">Avil Page</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="bs-navbar">
                <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../top-10.html" class="nav-link">Top 10</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Tech</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS</a>

                    
                </li>
</ul>
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
        </div>
<!-- /.container -->
    </nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="row justify-content-md-center">
        <div class="body-content col col-lg-6">
            <!--Body content-->
            
    <article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Continuous Deployment To Kubernetes With Skaffold</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card">
                <span class="byline-name fn p-name" itemprop="author">
                    Chillar Anand
                </span>
            </p>

            <p class="dateline">
                    6 min read
            </p>

            <p class="dateline">
                <a href="#" rel="bookmark">
                    <time class="published dt-published" datetime="2020-04-30T16:45:36+05:30" itemprop="datePublished" title="2020-04-30">2020-04-30</time></a>
            </p>
            
        </div>

        
    </header><div class="e-content entry-content" itemprop="articleBody text">
            <p>In this article, let us see how to set up a continuous deployment pipeline to Kubernetes in CircleCI using Skaffold.</p>
<h4>Prerequisites</h4>
<p>You should have a kubernetes cluster in a cloud environment or in your local machine. Check your cluster status with the following commands.</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>kubectl<span class="w"> </span>cluster-info
$<span class="w"> </span>kubectl<span class="w"> </span>config<span class="w"> </span>get-contexts
</pre></div>

<p>You should know how to manually deploy your application to kubernetes.</p>
<div class="code"><pre class="code literal-block"><span class="c1"># push latest docker image to container registry</span>
$<span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>chillaranand/library

<span class="c1"># deploy latest image to k8s</span>
$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>app/deployment.yaml
$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>app/service.yaml
</pre></div>

<h4>Skaffold</h4>
<p><a href="https://github.com/GoogleContainerTools/skaffold">Skaffold</a> is a CLI tool to facilitate continuous development and deployment workflows for Kubernetes applications.</p>
<p>Skaffold binaries are available for all platforms. Download the binary file for your OS and move it to bin folder.</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>curl<span class="w"> </span>-Lo<span class="w"> </span>skaffold<span class="w"> </span>https://storage.googleapis.com/skaffold/releases/latest/skaffold-darwin-amd64
$<span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>skaffold
$<span class="w"> </span>sudo<span class="w"> </span>mv<span class="w"> </span>skaffold<span class="w"> </span>/usr/local/bin
</pre></div>

<p>Inside your project root, run <code>init</code> command to generate a config file. If your project has k8s manifests, it will detect them and include it in the configuration file.</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>skaffold<span class="w"> </span>init
Configuration<span class="w"> </span>skaffold.yaml<span class="w"> </span>was<span class="w"> </span>written

$<span class="w"> </span>cat<span class="w"> </span>skaffold.yaml
apiVersion:<span class="w"> </span>skaffold/v2beta1
kind:<span class="w"> </span>Config
metadata:
<span class="w">  </span>name:<span class="w"> </span>library
build:
<span class="w">  </span>artifacts:
<span class="w">  </span>-<span class="w"> </span>image:<span class="w"> </span>docker.io/chillaranand/library
deploy:
<span class="w">  </span>kubectl:
<span class="w">    </span>manifests:
<span class="w">    </span>-<span class="w"> </span>kubernetes/deployment.yaml
<span class="w">    </span>-<span class="w"> </span>kubernetes/service.yaml
</pre></div>

<p>To deploy latest changes to your cluster, run</p>
<div class="code"><pre class="code literal-block">$<span class="w"> </span>skaffold<span class="w"> </span>run
</pre></div>

<p>This will build the docker image, push to registry and will apply the manifests in the clusters. Now, k8s will pull the latest image from the registry and create a new deployment.</p>
<h4>CircleCI Workflow</h4>
<div class="code"><pre class="code literal-block">version:<span class="w"> </span><span class="m">2</span>.1

orbs:
<span class="w">  </span>aws-cli:<span class="w"> </span>circleci/aws-cli@0.1.19
<span class="w">  </span>kubernetes:<span class="w"> </span>circleci/kubernetes@0.11.0

commands:
<span class="w">  </span>kubernetes-deploy:

<span class="w">    </span>steps:
<span class="w">      </span>-<span class="w"> </span>setup_remote_docker

<span class="w">      </span>-<span class="w"> </span>aws-cli/setup:
<span class="w">          </span>profile-name:<span class="w"> </span>default

<span class="w">      </span>-<span class="w"> </span>kubernetes/install-kubectl:
<span class="w">          </span>kubectl-version:<span class="w"> </span>v1.15.10

<span class="w">      </span>-<span class="w"> </span>checkout

<span class="w">      </span>-<span class="w"> </span>run:
<span class="w">          </span>name:<span class="w"> </span>container<span class="w"> </span>registry<span class="w"> </span>log<span class="w"> </span><span class="k">in</span>
<span class="w">          </span>command:<span class="w"> </span><span class="p">|</span>
<span class="w">            </span>sudo<span class="w"> </span><span class="k">$(</span>aws<span class="w"> </span>ecr<span class="w"> </span>get-login<span class="w"> </span>--region<span class="w"> </span>ap-south-1<span class="w"> </span>--no-include-email<span class="k">)</span>

<span class="w">      </span>-<span class="w"> </span>run:
<span class="w">          </span>name:<span class="w"> </span>install<span class="w"> </span>skaffold
<span class="w">          </span>command:<span class="w"> </span><span class="p">|</span>
<span class="w">            </span>curl<span class="w"> </span>-Lo<span class="w"> </span>skaffold<span class="w"> </span>https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
<span class="w">            </span>chmod<span class="w"> </span>+x<span class="w"> </span>skaffold
<span class="w">            </span>sudo<span class="w"> </span>mv<span class="w"> </span>skaffold<span class="w"> </span>/usr/local/bin

<span class="w">      </span>-<span class="w"> </span>run:
<span class="w">          </span>name:<span class="w"> </span>update<span class="w"> </span>kube<span class="w"> </span>config<span class="w"> </span>to<span class="w"> </span>connect<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>required<span class="w"> </span>cluster
<span class="w">          </span>command:<span class="w"> </span><span class="p">|</span>
<span class="w">            </span>aws<span class="w"> </span>eks<span class="w"> </span>--region<span class="w"> </span>ap-south-1<span class="w"> </span>update-kubeconfig<span class="w"> </span>--name<span class="w"> </span>demo-cluster

<span class="w">      </span>-<span class="w"> </span>run:
<span class="w">          </span>name:<span class="w"> </span>deploy<span class="w"> </span>to<span class="w"> </span>k8s
<span class="w">          </span>command:<span class="w"> </span><span class="p">|</span>
<span class="w">            </span>skaffold<span class="w"> </span>run
</pre></div>

<p>CircleCI orbs are shareable packages to speed up CI setup. Here we are using aws-cli, kubernetes orbs to easily install/setup them inside the CI environment.</p>
<p>Since CircleCI builds run in a docker container, to run docker commands inside container, we have to specify <code>setup_remote_docker</code> key so that a separate environment is created for it.</p>
<p>Remaining steps are self explainatory.</p>
<h4>Conclusion</h4>
<p>Here we have seen how to set up CD to kubernetes in CircleCI. If we want to set up this another CI like Jenkins or Travis, instead of using orbs, we have to use system package mangers like apt-get to install them. All others steps will remain same.</p>
        </div>
        <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../tags/aws.html" rel="tag">aws</a></li>
            <li><a class="tag p-category" href="../../tags/devops.html" rel="tag">devops</a></li>
            <li><a class="tag p-category" href="../../tags/kubernetes.html" rel="tag">kubernetes</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="work-from-home-tips.html" rel="prev" title="Work From Home Tips For Non-remote Workers">Previous post</a>
            </li>
            <li class="next">
                <a href="../05/tips-on-improving-kubectl-productivity.html" rel="next" title="Tips On Improving kubectl Productivity">Next post</a>
            </li>
        </ul></nav></aside><div class="full-article-footer">
            <div class="article-footer">

                <div class="avatar-module">
                    <img class="avatar" height="100px" src="../../images/chillaranand.jpg">
</div>

                <p class="avatar-module">
                    <b>Chillar Anand</b>
                    <br>
                    A blog about python, careers &amp; life.
                    <br>
                    To contact me, <a href="https://forms.gle/Hre4z4aLqJA5zYWe6">send a message here</a>.
                </p>

            </div>
        </div>

        
    </article><!--End of body content--><footer id="footer"><div class="container align-items-center justify-content-center d-flex">

<footer class="footer"><a href="https://github.com/ChillarAnand">
<img src="../../images/icons8-github.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://stackoverflow.com/users/2698552/chillar-anand">
<img src="../../images/icons8-so.svg" alt="github-chillar-anand" height="30"></a>

  

<a href="https://youtube.com/@avilpage">
<img src="../../images/icons8-youtube.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://linkedin.com/in/chillaranand">
<img src="../../images/icons8-linkedin.svg" alt="github-chillar-anand" height="34"></a>

  

<a href="https://twitter.com/chillaranand">
<img src="../../images/icons8-twitter.svg" alt="github-chillar-anand" height="34"></a>

</footer>
</div>

<br><br></footer>
</div>
    </div>
    </div>

                <script src="../../assets/js/jquery.min.js"></script><script src="../../assets/js/popper.min.js"></script><script src="../../assets/js/bootstrap.min.js"></script><script src="../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
